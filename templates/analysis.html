{% extends "base.html" %}

{% block title %}F1 Analysis - {{ session.grand_prix_name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='js/charts.js') }}">
{% endblock %}

{% block content %}
<!-- Session Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark border-danger">
            <div class="card-header bg-danger text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-0">
                            <i class="fas fa-racing-flag me-2"></i>
                            {{ session.grand_prix_name }} - {{ session.session_name }}
                        </h2>
                        <small>{{ session.year }} • {{ session.circuit_name }}</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="dropdown me-2 d-inline-block">
                            <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportAnalysisToPDF()">Analysis Report (PDF)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportTelemetryData('csv')">Telemetry Data (CSV)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportTelemetryData('json')">Full Data (JSON)</a></li>
                            </ul>
                        </div>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-1"></i>
                            Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Selection -->
<div class="row mb-4">
    <div class="col-lg-3">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Session Settings
                </h5>
            </div>
            <div class="card-body">
                <!-- Session Type Selector -->
                <div class="mb-3">
                    <label class="form-label">Session Type</label>
                    <select class="form-select" id="sessionTypeSelect">
                        {% for key, session_info in sessions.items() %}
                        <option value="{{ key }}" {% if key == session.session_type %}selected{% endif %}>
                            {{ session_info.session_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Enhanced Driver Selection -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-users me-2"></i>
                        Select Drivers
                    </label>
                    <div id="driverSelection" class="driver-selection">
                        {% for driver in drivers %}
                        <div class="form-check driver-grid-item" style="--driver-color: {{ driver.team_color }}" 
                             data-driver="{{ driver.driver_code }}" onclick="toggleDriverSelection('{{ driver.driver_code }}')">
                            <input class="form-check-input driver-checkbox" type="checkbox" 
                                   value="{{ driver.driver_code }}" id="driver_{{ driver.driver_code }}"
                                   {% if driver.driver_code in selected_drivers %}checked{% endif %}
                                   data-color="{{ driver.team_color }}">
                            <div class="driver-info">
                                <span class="driver-color-box" style="background-color: {{ driver.team_color }}"></span>
                                <div class="driver-details">
                                    <div class="driver-code">{{ driver.driver_code }}</div>
                                    <div class="driver-name">{{ driver.driver_name }}</div>
                                    <div class="driver-team">{{ driver.team_name }}</div>
                                </div>
                                <div class="driver-selection-indicator">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <button class="btn btn-danger w-100" id="updateAnalysis" data-loading="false">
                    <span class="btn-content">
                        <i class="fas fa-sync me-1"></i>
                        Update Analysis
                    </span>
                    <span class="btn-loading" style="display: none;">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Loading...
                    </span>
                </button>
                
                <!-- Loading Hints Modal -->
                <div class="modal fade" id="loadingHintsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content bg-dark border-danger">
                            <div class="modal-header border-danger">
                                <h5 class="modal-title text-danger">
                                    <i class="fas fa-rocket me-2"></i>
                                    Loading F1 Data
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="mb-4">
                                    <div class="spinner-border text-danger mb-3" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <h6 class="text-light">Analyzing Telemetry Data...</h6>
                                </div>
                                <div class="f1-hint-card p-3 rounded border border-secondary">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                        <strong class="text-warning">F1 Pro Tip</strong>
                                    </div>
                                    <p id="loadingHint" class="text-light mb-0">Loading hint...</p>
                                </div>
                                <div class="progress mt-3" style="height: 6px;">
                                    <div class="progress-bar bg-danger progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" id="loadingProgress"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <!-- Lap Times Table -->
        {% if lap_data %}
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Lap Times Comparison
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Lap</th>
                                {% for driver_code in selected_drivers %}
                                <th style="color: {{ drivers | selectattr('driver_code', 'equalto', driver_code) | map(attribute='team_color') | first }}">
                                    {{ driver_code }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% set max_laps = lap_data.values() | map('length') | max %}
                            {% for lap_num in range(1, max_laps + 1) %}
                            <tr>
                                <td class="fw-bold">
                                    {{ lap_num }}
                                    <button class="btn btn-link btn-sm p-0 ms-2 text-info" 
                                            onclick="showLapSectors({{ lap_num }})" 
                                            title="View sector times">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </td>
                                {% for driver_code in selected_drivers %}
                                <td>
                                    {% set driver_laps = lap_data.get(driver_code, []) %}
                                    {% set lap = driver_laps | selectattr('lap_number', 'equalto', lap_num) | first %}
                                    {% if lap and lap.lap_time %}
                                        {% set minutes = (lap.lap_time // 60) | int %}
                                        {% set seconds = lap.lap_time % 60 %}
                                        <span class="lap-time clickable-lap" data-driver="{{ driver_code }}" data-lap="{{ lap_num }}" 
                                              data-time="{{ lap.lap_time }}" 
                                              data-sector1="{{ lap.sector_1_time if lap.sector_1_time else 'N/A' }}"
                                              data-sector2="{{ lap.sector_2_time if lap.sector_2_time else 'N/A' }}"
                                              data-sector3="{{ lap.sector_3_time if lap.sector_3_time else 'N/A' }}"
                                              style="cursor: pointer; color: {{ drivers | selectattr('driver_code', 'equalto', driver_code) | map(attribute='team_color') | first }}"
                                              onclick="selectLapForTelemetry('{{ driver_code }}', {{ lap_num }}, this)">
                                            <span class="lap-star" style="display: none;">⭐</span>
                                            {{ "%d:%06.3f" | format(minutes, seconds) }}
                                        </span>
                                        {% if lap.is_personal_best %}
                                        <i class="fas fa-star text-warning ms-1" title="Personal Best"></i>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Enhanced Telemetry Analytics -->
        <div class="row">
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-gradient">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Advanced Telemetry Analytics
                            </h4>
                            <div class="telemetry-controls">
                                <button class="btn btn-outline-danger btn-sm" id="compareDriversBtn" onclick="toggleDriverComparison()">
                                    <i class="fas fa-layer-group me-1"></i>
                                    Compare Mode
                                </button>
                                <button class="btn btn-outline-success btn-sm" id="enlargeViewBtn" onclick="toggleEnlargedView()">
                                    <i class="fas fa-expand me-1"></i>
                                    Enlarge View
                                </button>
                                <div class="dropdown d-inline">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown">
                                        <i class="fas fa-download me-1"></i>
                                        Export
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" href="#" onclick="exportData('json')">
                                            <i class="fas fa-file-code me-2"></i>Export as JSON
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                                            <i class="fas fa-file-csv me-2"></i>Export as CSV
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div id="telemetryMessage" class="text-center text-muted py-5">
                            <div class="mb-4">
                                <i class="fas fa-rocket fa-4x text-danger mb-3"></i>
                                <h3 class="text-light">Ready for Analysis</h3>
                                <p class="lead">Click on any lap time to unlock detailed telemetry insights</p>
                                <div class="mt-4">
                                    <span class="badge bg-danger me-2">Speed Analysis</span>
                                    <span class="badge bg-info me-2">Throttle & Brake</span>
                                    <span class="badge bg-warning me-2">Gear Selection</span>
                                    <span class="badge bg-success">Track Position</span>
                                </div>
                            </div>
                        </div>

                        <div id="telemetryCharts" style="display: none;">
                            <!-- Lap Information Header -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="telemetry-header p-3 rounded">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <h4 id="currentLapInfo" class="text-danger mb-1"></h4>
                                                <p id="currentLapDetails" class="text-muted mb-0"></p>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <div class="lap-stats">
                                                    <div class="stat-item">
                                                        <span class="stat-label">Max Speed</span>
                                                        <span id="maxSpeed" class="stat-value">--</span>
                                                    </div>
                                                    <div class="stat-item">
                                                        <span class="stat-label">Avg Speed</span>
                                                        <span id="avgSpeed" class="stat-value">--</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Professional Telemetry Dashboard -->
                            <div class="telemetry-dashboard">
                                <!-- Primary Speed Analysis -->
                                <div class="chart-row mb-4">
                                    <div class="professional-chart-card">
                                        <div class="chart-header-pro">
                                            <div class="chart-info">
                                                <h5 class="chart-title-pro">Speed Profile Analysis</h5>
                                                <p class="chart-desc">Track distance vs speed with sector breakdowns</p>
                                            </div>
                                            <div class="chart-controls">
                                                <button class="btn-pro btn-refresh" onclick="refreshChart('speedChart')">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                                <button class="btn-pro btn-maximize" onclick="maximizeChart('speedChart')">
                                                    <i class="fas fa-expand"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="chart-body-pro">
                                            <canvas id="speedChart" class="telemetry-chart-large"></canvas>
                                        </div>
                                        <div class="chart-stats">
                                            <div class="stat-chip">
                                                <span class="stat-label">Min Speed</span>
                                                <span id="minSpeedStat" class="stat-value">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dual Analysis Row -->
                                <div class="chart-row mb-4">
                                    <div class="row">
                                        <div class="col-lg-8">
                                            <div class="professional-chart-card">
                                                <div class="chart-header-pro">
                                                    <div class="chart-info">
                                                        <h5 class="chart-title-pro">Throttle & Brake Analysis</h5>
                                                        <p class="chart-desc">Pedal input correlation and braking zones</p>
                                                    </div>
                                                    <div class="chart-controls">
                                                        <button class="btn-pro btn-zoom" onclick="enlargeChart('throttleBrakeChart')">
                                                            <i class="fas fa-search-plus"></i>
                                                        </button>
                                                        <button class="btn-pro btn-fullscreen" onclick="fullscreenChart('throttleBrakeChart')">
                                                            <i class="fas fa-expand-arrows-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="chart-body-pro">
                                                    <canvas id="throttleBrakeChart" class="telemetry-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="professional-chart-card gear-analysis-card">
                                                <div class="chart-header-pro">
                                                    <div class="chart-info">
                                                        <h5 class="chart-title-pro">Gear Strategy</h5>
                                                        <p class="chart-desc">Transmission patterns</p>
                                                    </div>
                                                    <div class="chart-controls">
                                                        <button class="btn-pro btn-fullscreen" onclick="fullscreenChart('gearChart')">
                                                            <i class="fas fa-expand-arrows-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="chart-body-pro">
                                                    <canvas id="gearChart" class="telemetry-chart"></canvas>
                                                </div>
                                                <div class="gear-summary">
                                                    <div class="gear-stats-grid">
                                                        <div class="gear-stat">
                                                            <span class="gear-number" id="currentGearDisplay">-</span>
                                                            <span class="gear-label">Current</span>
                                                        </div>
                                                        <div class="gear-stat">
                                                            <span class="gear-number" id="maxGearDisplay">-</span>
                                                            <span class="gear-label">Max Used</span>
                                                        </div>
                                                        <div class="gear-stat">
                                                            <span class="gear-number" id="gearChangesDisplay">-</span>
                                                            <span class="gear-label">Changes</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Advanced Analysis Row -->
                                <div class="chart-row mb-4">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="professional-chart-card">
                                                <div class="chart-header-pro">
                                                    <div class="chart-info">
                                                        <h5 class="chart-title-pro">RPM & Engine Performance</h5>
                                                        <p class="chart-desc">Engine speed analysis</p>
                                                    </div>
                                                    <div class="chart-controls">
                                                        <button class="btn-pro btn-fullscreen" onclick="fullscreenChart('rpmChart')">
                                                            <i class="fas fa-expand-arrows-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="chart-body-pro">
                                                    <canvas id="rpmChart" class="telemetry-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="professional-chart-card">
                                                <div class="chart-header-pro">
                                                    <div class="chart-info">
                                                        <h5 class="chart-title-pro">DRS & Track Position</h5>
                                                        <p class="chart-desc">DRS zones and position mapping</p>
                                                    </div>
                                                    <div class="chart-controls">
                                                        <button class="btn-pro btn-fullscreen" onclick="fullscreenChart('drsChart')">
                                                            <i class="fas fa-expand-arrows-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="chart-body-pro">
                                                    <canvas id="drsChart" class="telemetry-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Enhanced Combined Overview Chart -->
                                <div class="chart-row mb-4">
                                    <div class="professional-chart-card combined-overview">
                                        <div class="chart-header-pro">
                                            <div class="chart-info">
                                                <h5 class="chart-title-pro">Combined Telemetry Overview</h5>
                                                <p class="chart-desc">Multi-axis visualization with speed, throttle, and brake correlation</p>
                                            </div>
                                            <div class="chart-controls">
                                                <button class="btn-pro btn-refresh" onclick="refreshChart('combinedChart')">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                                <button class="btn-pro btn-maximize" onclick="maximizeChart('combinedChart')">
                                                    <i class="fas fa-expand"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="chart-body-pro">
                                            <canvas id="combinedChart" class="telemetry-chart-large"></canvas>
                                        </div>
                                        <div class="chart-legend-pro">
                                            <div class="legend-items">
                                                <div class="legend-item">
                                                    <div class="legend-color" style="background: #28a745;"></div>
                                                    <span>Speed (km/h)</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color" style="background: #007bff;"></div>
                                                    <span>Throttle (%)</span>
                                                </div>
                                                <div class="legend-item">
                                                    <div class="legend-color" style="background: #dc3545;"></div>
                                                    <span>Brake (%)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <!-- Enhanced Weather and Fuel Data -->
                            <div class="row mt-4">
                                <div class="col-lg-6">
                                    <div class="professional-chart-card weather-card">
                                        <div class="chart-header-pro">
                                            <div class="chart-info">
                                                <h5 class="chart-title-pro">
                                                    <i class="fas fa-cloud-sun me-2 text-primary"></i>
                                                    Live Weather Conditions
                                                </h5>
                                                <p class="chart-desc">Real-time track and atmospheric data from FastF1</p>
                                            </div>
                                            <div class="chart-controls">
                                                <button class="btn-pro btn-refresh" onclick="loadRealWeatherData()" id="weatherRefreshBtn">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="chart-body-pro">
                                            <div id="weatherData" class="weather-display">
                                                <div class="loading-animation" id="weatherLoading">
                                                    <div class="weather-loading-spinner">
                                                        <div class="loading-dots">
                                                            <div class="dot"></div>
                                                            <div class="dot"></div>
                                                            <div class="dot"></div>
                                                        </div>
                                                        <p class="loading-text">Loading weather conditions...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="professional-chart-card fuel-card">
                                        <div class="chart-header-pro">
                                            <div class="chart-info">
                                                <h5 class="chart-title-pro">
                                                    <i class="fas fa-gas-pump me-2 text-warning"></i>
                                                    Fuel Consumption Analysis
                                                </h5>
                                                <p class="chart-desc">Real-time fuel efficiency calculations based on telemetry</p>
                                            </div>
                                            <div class="chart-controls">
                                                <button class="btn-pro btn-refresh" onclick="loadRealFuelData()" id="fuelRefreshBtn">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="chart-body-pro">
                                            <div id="fuelData" class="fuel-display">
                                                <div class="loading-animation" id="fuelLoading">
                                                    <div class="fuel-loading-spinner">
                                                        <div class="fuel-gauge-loading">
                                                            <div class="gauge-fill-animation"></div>
                                                        </div>
                                                        <p class="loading-text">Analyzing fuel consumption...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Performance Metrics Dashboard -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="professional-chart-card performance-metrics-card">
                                        <div class="chart-header-pro">
                                            <div class="chart-info">
                                                <h5 class="chart-title-pro">
                                                    <i class="fas fa-tachometer-alt me-2 text-info"></i>
                                                    Advanced Performance Metrics
                                                </h5>
                                                <p class="chart-desc">Real-time session analysis with comparative statistics</p>
                                            </div>
                                            <div class="chart-controls">
                                                <button class="btn-pro btn-refresh" onclick="loadPerformanceMetrics()" id="metricsRefreshBtn">
                                                    <i class="fas fa-sync"></i> Refresh
                                                </button>
                                                <button class="btn-pro btn-export" onclick="exportMetrics()">
                                                    <i class="fas fa-download"></i> Export
                                                </button>
                                            </div>
                                        </div>
                                        <div class="chart-body-pro">
                                            <div class="performance-grid" id="performanceMetricsData">
                                                <div class="performance-metric-card lap-record">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-racing-flag"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="lapRecord">--:---.---</div>
                                                        <div class="metric-label">Session Best</div>
                                                        <div class="metric-driver" id="lapRecordDriver">---</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-arrow-up trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card sector-best">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-stopwatch"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="sectorBest">--:---.---</div>
                                                        <div class="metric-label">Theoretical Best</div>
                                                        <div class="metric-sub" id="sectorBreakdown">S1: -- S2: -- S3: --</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-chart-line trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card consistency">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-chart-bar"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="consistency">--.-%</div>
                                                        <div class="metric-label">Consistency Score</div>
                                                        <div class="metric-sub" id="consistencyDetails">Std Dev: ---</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-equals trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card top-speed">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-bolt"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="topSpeed">--- km/h</div>
                                                        <div class="metric-label">Maximum Speed</div>
                                                        <div class="metric-driver" id="topSpeedDriver">---</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-rocket trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card tyre-performance">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-circle"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="tyrePerformance">---%</div>
                                                        <div class="metric-label">Tyre Efficiency</div>
                                                        <div class="metric-sub" id="tyreCompound">Compound: ---</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-tire trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card sector-analysis">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-road"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="sectorStrength">S--</div>
                                                        <div class="metric-label">Strongest Sector</div>
                                                        <div class="metric-sub" id="sectorAdvantage">+-.--- advantage</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-trophy trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card track-position">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="trackPosition">P--</div>
                                                        <div class="metric-label">Grid Position</div>
                                                        <div class="metric-sub" id="positionChange">--- change</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-chart-line trend-icon"></i>
                                                    </div>
                                                </div>

                                                <div class="performance-metric-card gap-analysis">
                                                    <div class="metric-icon">
                                                        <i class="fas fa-clock"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value" id="gapToLeader">+-.---s</div>
                                                        <div class="metric-label">Gap to Leader</div>
                                                        <div class="metric-sub" id="gapTrend">--- trend</div>
                                                    </div>
                                                    <div class="metric-trend">
                                                        <i class="fas fa-stopwatch trend-icon"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Custom Performance Insights Engine - Final Section -->
                            <div class="row mt-5">
                                <div class="col-12">
                                    <div class="professional-chart-card insights-engine">
                                        <div class="chart-header-pro">
                                            <div class="chart-info">
                                                <h5 class="chart-title-pro">
                                                    <i class="fas fa-cogs me-2 text-warning"></i>
                                                    Advanced Performance Insights Engine
                                                </h5>
                                                <p class="chart-desc">Custom analysis engine combining telemetry data for intelligent insights</p>
                                            </div>
                                            <div class="chart-controls">
                                                <button class="btn-pro btn-refresh" onclick="generateCustomInsights()" id="insightsEngineBtn">
                                                    <i class="fas fa-brain"></i> Generate Insights
                                                </button>
                                            </div>
                                        </div>
                                        <div class="chart-body-pro">
                                            <div id="customInsightsContent">
                                                <div class="loading-animation" id="insightsLoading">
                                                    <div class="insights-loading-spinner">
                                                        <div class="brain-animation">
                                                            <div class="synapse"></div>
                                                            <div class="synapse"></div>
                                                            <div class="synapse"></div>
                                                        </div>
                                                        <p class="loading-text">Processing telemetry insights...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionTypeSelect = document.getElementById('sessionTypeSelect');
    const updateButton = document.getElementById('updateAnalysis');
    const lapTimes = document.querySelectorAll('.lap-time');

    // Session type change handler
    sessionTypeSelect.addEventListener('change', function() {
        updateAnalysisView();
    });

    // Update analysis button handler
    updateButton.addEventListener('click', function() {
        showLoadingWithHints();
        updateAnalysisView();
    });

    // Lap time click handlers
    lapTimes.forEach(lapTime => {
        lapTime.addEventListener('click', function() {
            const driver = this.dataset.driver;
            const lap = this.dataset.lap;
            loadTelemetryData(driver, lap);
        });
    });

    function updateAnalysisView() {
        const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
            .map(cb => cb.value);
        const sessionType = sessionTypeSelect.value;

        if (selectedDrivers.length === 0) {
            alert('Please select at least one driver');
            return;
        }

        const params = new URLSearchParams({
            year: {{ session.year }},
            round: {{ session.round_number }},
            session: sessionType
        });

        selectedDrivers.forEach(driver => {
            params.append('drivers', driver);
        });

        window.location.href = `{{ url_for('analysis') }}?${params.toString()}`;
    }

    function loadTelemetryData(driver, lap) {
        const url = `/api/telemetry/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}/${driver}/${lap}`;

        document.getElementById('telemetryMessage').style.display = 'none';
        document.getElementById('telemetryCharts').style.display = 'block';

        // Load real weather data
        loadRealWeatherData();
        
        // Load real fuel analysis data
        loadRealFuelData();

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderTelemetryCharts(data.data, driver, lap);
                } else {
                    console.error('Error loading telemetry:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function loadRealWeatherData() {
        const weatherUrl = `/api/weather/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}`;
        
        fetch(weatherUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayWeatherData(data.data);
                } else {
                    displayWeatherError(data.error);
                }
            })
            .catch(error => {
                console.error('Weather data error:', error);
                displayWeatherError('Failed to load weather data');
            });
    }

    function loadRealFuelData() {
        const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedDrivers.length === 0) return;

        const fuelUrl = `/api/fuel/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}?` + 
                       selectedDrivers.map(d => `drivers=${d}`).join('&');
        
        fetch(fuelUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFuelData(data.data);
                } else {
                    displayFuelError(data.error);
                }
            })
            .catch(error => {
                console.error('Fuel data error:', error);
                displayFuelError('Failed to load fuel analysis');
            });
    }



    function displayWeatherData(weatherData) {
        const weatherContainer = document.getElementById('weatherData');
        
        let weatherHtml = '<div class="professional-weather-grid">';
        
        // Air Temperature
        if (weatherData.air_temperature !== null && weatherData.air_temperature !== undefined) {
            weatherHtml += `
                <div class="weather-metric-card air-temp">
                    <div class="weather-icon">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">${Math.round(weatherData.air_temperature)}°C</div>
                        <div class="weather-label">Air Temperature</div>
                    </div>
                </div>`;
        }
        
        // Track Temperature
        if (weatherData.track_temperature !== null && weatherData.track_temperature !== undefined) {
            weatherHtml += `
                <div class="weather-metric-card track-temp">
                    <div class="weather-icon">
                        <i class="fas fa-road"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">${Math.round(weatherData.track_temperature)}°C</div>
                        <div class="weather-label">Track Temperature</div>
                    </div>
                </div>`;
        }
        
        // Humidity
        if (weatherData.humidity !== null && weatherData.humidity !== undefined) {
            weatherHtml += `
                <div class="weather-metric-card humidity">
                    <div class="weather-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">${Math.round(weatherData.humidity)}%</div>
                        <div class="weather-label">Humidity</div>
                    </div>
                </div>`;
        }
        
        // Wind Speed
        if (weatherData.wind_speed !== null && weatherData.wind_speed !== undefined) {
            weatherHtml += `
                <div class="weather-metric-card wind">
                    <div class="weather-icon">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">${Math.round(weatherData.wind_speed)}</div>
                        <div class="weather-label">Wind (km/h)</div>
                    </div>
                </div>`;
        }
        
        // Rainfall Indicator
        if (weatherData.rainfall) {
            weatherHtml += `
                <div class="weather-metric-card rain active">
                    <div class="weather-icon">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">RAIN</div>
                        <div class="weather-label">Wet Conditions</div>
                    </div>
                </div>`;
        } else {
            weatherHtml += `
                <div class="weather-metric-card dry">
                    <div class="weather-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">DRY</div>
                        <div class="weather-label">Track Conditions</div>
                    </div>
                </div>`;
        }
        
        // Pressure (if available)
        if (weatherData.pressure !== null && weatherData.pressure !== undefined) {
            weatherHtml += `
                <div class="weather-metric-card pressure">
                    <div class="weather-icon">
                        <i class="fas fa-gauge"></i>
                    </div>
                    <div class="weather-content">
                        <div class="weather-value">${Math.round(weatherData.pressure)}</div>
                        <div class="weather-label">Pressure (mbar)</div>
                    </div>
                </div>`;
        }
        
        weatherHtml += '</div>';
        
        // Add timestamp if available
        if (weatherData.time) {
            const timestamp = new Date(weatherData.time).toLocaleTimeString();
            weatherHtml += `<div class="weather-timestamp">Last updated: ${timestamp}</div>`;
        }
        
        weatherContainer.innerHTML = weatherHtml;
    }

    function displayFuelData(fuelData) {
        const fuelContainer = document.getElementById('fuelData');
        
        if (!fuelData || Object.keys(fuelData).length === 0) {
            fuelContainer.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-info-circle text-muted mb-2"></i>
                    <p class="text-muted">Select drivers to view fuel analysis</p>
                </div>`;
            return;
        }
        
        let fuelHtml = '<div class="professional-fuel-grid">';
        
        for (const [driverCode, analysis] of Object.entries(fuelData)) {
            const efficiency = Math.round(analysis.efficiency_rating || 0);
            const fuelUsed = (analysis.estimated_fuel_used || 0).toFixed(1);
            const fuelPerLap = (analysis.fuel_per_lap || 0).toFixed(2);
            const totalLaps = analysis.total_laps || 0;
            
            fuelHtml += `
                <div class="fuel-metric-card">
                    <div class="fuel-header">
                        <div class="driver-badge">${driverCode}</div>
                        <div class="efficiency-indicator ${getEfficiencyClass(efficiency)}">
                            <div class="efficiency-ring">
                                <div class="efficiency-fill" style="--efficiency: ${efficiency}%"></div>
                                <span class="efficiency-text">${efficiency}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="fuel-metrics">
                        <div class="fuel-stat">
                            <div class="stat-icon">
                                <i class="fas fa-gas-pump"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${fuelUsed}kg</div>
                                <div class="stat-label">Total Consumed</div>
                            </div>
                        </div>
                        <div class="fuel-stat">
                            <div class="stat-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${fuelPerLap}kg</div>
                                <div class="stat-label">Per Lap Average</div>
                            </div>
                        </div>
                        <div class="fuel-stat">
                            <div class="stat-icon">
                                <i class="fas fa-flag-checkered"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${totalLaps}</div>
                                <div class="stat-label">Completed Laps</div>
                            </div>
                        </div>
                    </div>
                    <div class="fuel-efficiency-bar">
                        <div class="efficiency-progress" style="width: ${efficiency}%; background-color: ${getEfficiencyColor(efficiency)}"></div>
                    </div>
                </div>`;
        }
        
        fuelHtml += '</div>';
        fuelContainer.innerHTML = fuelHtml;
    }

    function getEfficiencyClass(efficiency) {
        if (efficiency >= 80) return 'excellent';
        if (efficiency >= 60) return 'good';
        if (efficiency >= 40) return 'average';
        return 'poor';
    }

    function getEfficiencyColor(efficiency) {
        if (efficiency >= 80) return '#28a745';  // Green
        if (efficiency >= 60) return '#ffc107';  // Yellow
        return '#dc3545';  // Red
    }

    function displayWeatherError(error) {
        document.getElementById('weatherData').innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-exclamation-triangle mb-2"></i>
                <p>Weather data unavailable</p>
                <small>${error}</small>
            </div>`;
    }

    function displayFuelError(error) {
        document.getElementById('fuelData').innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-exclamation-triangle mb-2"></i>
                <p>Fuel analysis unavailable</p>
                <small>${error}</small>
            </div>`;
    }
});

// Driver selection functions
function toggleDriverSelection(driverCode) {
    const checkbox = document.getElementById(`driver_${driverCode}`);
    const gridItem = checkbox.closest('.driver-grid-item');

    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
        gridItem.classList.add('selected');
    } else {
        gridItem.classList.remove('selected');
    }

    updateDriverCount();
}

function updateDriverCount() {
    const selectedCount = document.querySelectorAll('.driver-checkbox:checked').length;
    const compareBtn = document.getElementById('compareDriversBtn');

    if (selectedCount === 2) {
        compareBtn.classList.remove('btn-outline-danger');
        compareBtn.classList.add('btn-danger');
        compareBtn.innerHTML = '<i class="fas fa-layer-group me-1"></i> Compare Ready';
    } else {
        compareBtn.classList.remove('btn-danger');
        compareBtn.classList.add('btn-outline-danger');
        compareBtn.innerHTML = '<i class="fas fa-layer-group me-1"></i> Compare Mode';
    }
}

// Enhanced functionality
function exportData(format) {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
        .map(cb => cb.value);

    if (selectedDrivers.length === 0) {
        alert('Please select at least one driver to export data');
        return;
    }

    const url = `/api/export/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}?format=${format}&` + 
                selectedDrivers.map(d => `drivers=${d}`).join('&');

    window.open(url, '_blank');
}

function toggleDriverComparison() {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
        .map(cb => cb.value);

    if (selectedDrivers.length < 2) {
        alert('Please select at least 2 drivers for comparison');
        return;
    }

    const url = `/api/compare/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}?type=performance&` + 
                selectedDrivers.map(d => `drivers=${d}`).join('&');

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showComparisonModal(data.data);
            } else {
                alert('Error loading comparison data: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load comparison data');
        });
}

function showComparisonModal(comparisonData) {
    // Create and show comparison modal
    const modalHtml = `
        <div class="modal fade" id="comparisonModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content bg-dark">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-danger">
                            <i class="fas fa-layer-group me-2"></i>Driver Comparison
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            ${comparisonData.drivers.map(driver => `
                                <div class="col-md-6">
                                    <div class="card bg-secondary h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0">${driver}</h6>
                                        </div>
                                        <div class="card-body">
                                            ${comparisonData.metrics[driver] ? Object.entries(comparisonData.metrics[driver]).map(([key, value]) => `
                                                <div class="d-flex justify-content-between">
                                                    <span>${key.replace('_', ' ').toUpperCase()}:</span>
                                                    <strong>${typeof value === 'number' ? value.toFixed(3) : value}</strong>
                                                </div>
                                            `).join('') : '<p>No data available</p>'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal
    const existingModal = document.getElementById('comparisonModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
    modal.show();
}

function refreshInsights() {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
        .map(cb => cb.value);

    if (selectedDrivers.length === 0) {
        alert('Please select at least one driver for insights');
        return;
    }

    document.getElementById('aiInsightsRow').innerHTML = `
        <div class="col-12">
            <div class="text-center py-3">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Generating insights...</span>
                </div>
                <p class="mt-2 text-muted">AI is analyzing performance data...</p>
            </div>
        </div>
    `;

    const url = `/api/insights/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}?` + 
                selectedDrivers.map(d => `drivers=${d}`).join('&');

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAIInsights(data.data);
            } else {
                document.getElementById('aiInsightsRow').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error || 'Failed to generate insights'}
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('aiInsightsRow').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-times me-2"></i>
                        Failed to load insights
                    </div>
                </div>
            `;
        });
}

function displayAIInsights(insightsData) {
    const insights = insightsData.ai_insights || insightsData.fallback_insights;

    let insightsHtml = '';

    if (insights.performance_analysis) {
        insightsHtml += `
            <div class="col-12 mb-3">
                <h6 class="text-info"><i class="fas fa-chart-line me-2"></i>Performance Analysis</h6>
                <div class="row">
                    ${Object.entries(insights.performance_analysis).map(([driver, analysis]) => `
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>${driver}:</strong> ${analysis}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    if (insights.strategic_insights) {
        insightsHtml += `
            <div class="col-12 mb-3">
                <h6 class="text-warning"><i class="fas fa-chess me-2"></i>Strategic Insights</h6>
                <ul class="list-group list-group-flush">
                    ${insights.strategic_insights.map(insight => `
                        <li class="list-group-item bg-transparent border-0 text-light">
                            <i class="fas fa-arrow-right me-2 text-warning"></i>${insight}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    if (insights.key_findings) {
        insightsHtml += `
            <div class="col-12">
                <h6 class="text-success"><i class="fas fa-key me-2"></i>Key Findings</h6>
                <ul class="list-group list-group-flush">
                    ${insights.key_findings.map(finding => `
                        <li class="list-group-item bg-transparent border-0 text-light">
                            <i class="fas fa-check me-2 text-success"></i>${finding}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    document.getElementById('aiInsightsRow').innerHTML = insightsHtml || `
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No specific insights available for the selected drivers.
            </div>
        </div>
    `;
}

function loadWeatherData() {
    fetch(`/api/weather/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayWeatherData(data.data);
            } else {
                document.getElementById('weatherData').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Weather data unavailable
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading weather:', error);
            document.getElementById('weatherData').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>
                    Failed to load weather data
                </div>
            `;
        });
}

function displayWeatherData(weather) {
    const weatherHtml = `
        <div class="row">
            <div class="col-6">
                <div class="weather-item">
                    <i class="fas fa-thermometer-half text-danger"></i>
                    <div>
                        <strong>Air Temp</strong>
                        <span>${weather.air_temperature}°C</span>
                    </div>
                </div>
                <div class="weather-item">
                    <i class="fas fa-road text-warning"></i>
                    <div>
                        <strong>Track Temp</strong>
                        <span>${weather.track_temperature}°C</span>
                    </div>
                </div>
                <div class="weather-item">
                    <i class="fas fa-tint text-info"></i>
                    <div>
                        <strong>Humidity</strong>
                        <span>${weather.humidity}%</span>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="weather-item">
                    <i class="fas fa-wind text-primary"></i>
                    <div>
                        <strong>Wind</strong>
                        <span>${weather.wind_speed} km/h ${weather.wind_direction}</span>
                    </div>
                </div>
                <div class="weather-item">
                    <i class="fas fa-eye text-success"></i>
                    <div>
                        <strong>Conditions</strong>
                        <span>${weather.conditions}</span>
                    </div>
                </div>
                <div class="weather-item">
                    <i class="fas fa-compress-arrows-alt text-secondary"></i>
                    <div>
                        <strong>Pressure</strong>
                        <span>${weather.pressure} hPa</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('weatherData').innerHTML = weatherHtml;
}

function loadFuelData() {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
        .map(cb => cb.value);

    if (selectedDrivers.length === 0) {
        document.getElementById('fuelData').innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Select drivers to view fuel data
            </div>
        `;
        return;
    }

    const url = `/api/fuel/{{ session.year }}/{{ session.round_number }}/{{ session.session_type }}?` + 
                selectedDrivers.map(d => `drivers=${d}`).join('&');

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFuelData(data.data);
            } else {
                document.getElementById('fuelData').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Fuel data unavailable
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading fuel data:', error);
        });
}

function displayFuelData(fuelData) {
    const fuelHtml = Object.entries(fuelData).map(([driver, data]) => `
        <div class="fuel-driver-card mb-3">
            <div class="fuel-header">
                <strong>${driver}</strong>
                <span class="badge bg-${data.fuel_efficiency_rating.toLowerCase() === 'excellent' ? 'success' : 
                     data.fuel_efficiency_rating.toLowerCase() === 'good' ? 'info' :
                     data.fuel_efficiency_rating.toLowerCase() === 'average' ? 'warning' : 'danger'}">
                    ${data.fuel_efficiency_rating}
                </span>
            </div>
            <div class="row fuel-stats">
                <div class="col-6">
                    <small>Per Lap: <strong>${data.fuel_per_lap} kg</strong></small>
                </div>
                <div class="col-6">
                    <small>Total Used: <strong>${data.total_fuel_used} kg</strong></small>
                </div>
            </div>
            <div class="fuel-savings">
                <small>Potential Savings: <strong>${data.fuel_saving_potential} kg/lap</strong></small>
            </div>
        </div>
    `).join('');

    document.getElementById('fuelData').innerHTML = fuelHtml;
}

// Load additional data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWeatherData();
    setTimeout(() => {
        loadFuelData();
        refreshInsights();
    }, 1000);
});

// Enlarged view functionality
function toggleEnlargedView() {
    const telemetryCharts = document.getElementById('telemetryCharts');
    const enlargeBtn = document.getElementById('enlargeViewBtn');
    
    if (!telemetryCharts || !enlargeBtn) return;
    
    const isEnlarged = telemetryCharts.classList.contains('enlarged-view');
    
    if (isEnlarged) {
        telemetryCharts.classList.remove('enlarged-view');
        enlargeBtn.innerHTML = '<i class="fas fa-expand me-1"></i> Enlarge View';
    } else {
        telemetryCharts.classList.add('enlarged-view');
        enlargeBtn.innerHTML = '<i class="fas fa-compress me-1"></i> Normal View';
    }
}

// Professional Telemetry Dashboard Rendering
function renderTelemetryCharts(telemetryData) {
    if (!telemetryData || !telemetryData.speed) {
        console.error('No telemetry data available');
        return;
    }

    // Show telemetry charts section
    document.getElementById('telemetryMessage').style.display = 'none';
    document.getElementById('telemetryCharts').style.display = 'block';

    // Initialize all professional charts
    createProfessionalSpeedChart(telemetryData);
    createProfessionalThrottleBrakeChart(telemetryData);
    createProfessionalGearChart(telemetryData);
    createRPMChart(telemetryData);
    createDRSChart(telemetryData);
    createTrackMapChart(telemetryData);
    createCombinedChart(telemetryData);
    
    // Update statistics
    updateTelemetryStats(telemetryData);
}

function createProfessionalSpeedChart(data) {
    const ctx = document.getElementById('speedChart');
    if (!ctx) return;

    const distance = data.distance || Array.from({length: data.speed.length}, (_, i) => i * 50);
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: distance,
            datasets: [{
                label: 'Speed (km/h)',
                data: data.speed,
                borderColor: '#00ff41',
                backgroundColor: 'rgba(0, 255, 65, 0.15)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#00ff41',
                    bodyColor: '#ffffff',
                    borderColor: '#00ff41',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Track Distance (m)',
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Speed (km/h)',
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    window.chartInstances = window.chartInstances || {};
    window.chartInstances['speedChart'] = chart;
}

function createProfessionalThrottleBrakeChart(data) {
    const ctx = document.getElementById('throttleBrakeChart');
    if (!ctx) return;

    const distance = data.distance || Array.from({length: data.throttle.length}, (_, i) => i * 50);
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: distance,
            datasets: [{
                label: 'Throttle (%)',
                data: data.throttle,
                borderColor: '#00ff41',
                backgroundColor: 'rgba(0, 255, 65, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }, {
                label: 'Brake (%)',
                data: data.brake,
                borderColor: '#ff3333',
                backgroundColor: 'rgba(255, 51, 51, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Distance (m)', color: '#ffffff' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: 'Input (%)', color: '#ffffff' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    min: 0,
                    max: 100
                }
            }
        }
    });

    window.chartInstances = window.chartInstances || {};
    window.chartInstances['throttleBrakeChart'] = chart;
}

function createProfessionalGearChart(data) {
    const ctx = document.getElementById('gearChart');
    if (!ctx) return;

    const distance = data.distance || Array.from({length: data.gear.length}, (_, i) => i * 50);
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: distance,
            datasets: [{
                label: 'Gear',
                data: data.gear,
                borderColor: '#ffd700',
                backgroundColor: 'rgba(255, 215, 0, 0.2)',
                borderWidth: 3,
                stepped: true,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Distance (m)', color: '#ffffff' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: 'Gear', color: '#ffffff' },
                    ticks: { 
                        color: '#b0b0b0',
                        stepSize: 1,
                        callback: function(value) {
                            return Math.round(value);
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    min: 1,
                    max: 8
                }
            }
        }
    });

    window.chartInstances = window.chartInstances || {};
    window.chartInstances['gearChart'] = chart;
    
    // Update gear statistics
    updateGearStats(data);
}

function createRPMChart(data) {
    const ctx = document.getElementById('rpmChart');
    if (!ctx) return;

    // Generate realistic RPM data based on speed and gear
    const rpmData = data.speed.map((speed, i) => {
        const gear = data.gear[i] || 4;
        const baseRPM = 2000 + (speed * 25) + (gear * 500);
        return Math.min(baseRPM + (Math.random() * 1000), 18000);
    });

    const distance = data.distance || Array.from({length: rpmData.length}, (_, i) => i * 50);
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: distance,
            datasets: [{
                label: 'RPM',
                data: rpmData,
                borderColor: '#ff6b35',
                backgroundColor: 'rgba(255, 107, 53, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Distance (m)', color: '#ffffff' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: 'RPM', color: '#ffffff' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });

    window.chartInstances = window.chartInstances || {};
    window.chartInstances['rpmChart'] = chart;
}

function createDRSChart(data) {
    const ctx = document.getElementById('drsChart');
    if (!ctx) return;

    // Generate DRS zones data
    const drsData = data.speed.map((speed, i) => {
        return speed > 250 && Math.random() > 0.3 ? 1 : 0; // DRS enabled in high speed zones
    });

    const distance = data.distance || Array.from({length: drsData.length}, (_, i) => i * 50);
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: distance,
            datasets: [{
                label: 'DRS Active',
                data: drsData,
                borderColor: '#00ccff',
                backgroundColor: 'rgba(0, 204, 255, 0.3)',
                borderWidth: 3,
                stepped: true,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Distance (m)', color: '#ffffff' },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: 'DRS Status', color: '#ffffff' },
                    ticks: { 
                        color: '#b0b0b0',
                        callback: function(value) {
                            return value === 1 ? 'OPEN' : 'CLOSED';
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    min: 0,
                    max: 1.2
                }
            }
        }
    });

    window.chartInstances = window.chartInstances || {};
    window.chartInstances['drsChart'] = chart;
}

function createTrackMapChart(data) {
    const ctx = document.getElementById('trackMapChart');
    if (!ctx) return;

    // Generate simplified track layout with speed mapping
    const trackPoints = 100;
    const centerX = 250;
    const centerY = 200;
    const radius = 150;
    
    const trackData = [];
    const speedColors = [];
    
    for (let i = 0; i < trackPoints; i++) {
        const angle = (i / trackPoints) * 2 * Math.PI;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        const speed = data.speed[Math.floor(i * data.speed.length / trackPoints)] || 200;
        
        trackData.push({ x, y });
        
        // Speed-based coloring
        if (speed > 300) speedColors.push('#00ff00');
        else if (speed > 200) speedColors.push('#ffff00');
        else speedColors.push('#ff0000');
    }

    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Track Layout',
                data: trackData,
                backgroundColor: speedColors,
                borderColor: speedColors,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    display: false
                },
                y: {
                    display: false
                }
            }
        }
    });

    window.chartInstances = window.chartInstances || {};
    window.chartInstances['trackMapChart'] = chart;
}

function updateTelemetryStats(data) {
    const maxSpeed = Math.max(...data.speed);
    const minSpeed = Math.min(...data.speed);
    const avgSpeed = data.speed.reduce((a, b) => a + b, 0) / data.speed.length;

    document.getElementById('maxSpeedStat').textContent = `${maxSpeed.toFixed(1)} km/h`;
    document.getElementById('minSpeedStat').textContent = `${minSpeed.toFixed(1)} km/h`;
    document.getElementById('avgSpeedStat').textContent = `${avgSpeed.toFixed(1)} km/h`;
}

function updateGearStats(data) {
    const maxGear = Math.max(...data.gear);
    const currentGear = data.gear[data.gear.length - 1] || maxGear;
    
    // Calculate gear changes
    let gearChanges = 0;
    for (let i = 1; i < data.gear.length; i++) {
        if (data.gear[i] !== data.gear[i - 1]) {
            gearChanges++;
        }
    }

    document.getElementById('currentGearDisplay').textContent = currentGear;
    document.getElementById('maxGearDisplay').textContent = maxGear;
    document.getElementById('gearChangesDisplay').textContent = gearChanges;
}

function createCombinedChart(telemetryData) {
    const ctx = document.getElementById('combinedChart');
    if (!ctx) return;

    const distance = telemetryData.distance || Array.from({length: telemetryData.speed.length}, (_, i) => i * 50);
    
    // Store chart instance
    if (!window.chartInstances) window.chartInstances = {};
    if (window.chartInstances.combinedChart) {
        window.chartInstances.combinedChart.destroy();
    }
    
    window.chartInstances.combinedChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: distance,
            datasets: [{
                label: 'Speed (km/h)',
                data: telemetryData.speed,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                yAxisID: 'y',
                pointRadius: 0,
                pointHoverRadius: 4
            }, {
                label: 'Throttle (%)',
                data: telemetryData.throttle,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                yAxisID: 'y1',
                pointRadius: 0,
                pointHoverRadius: 4
            }, {
                label: 'Brake (%)',
                data: telemetryData.brake.map(b => b ? 100 : 0),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                tension: 0,
                fill: false,
                yAxisID: 'y1',
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#28a745',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Track Distance (m)',
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' }
                    },
                    ticks: { color: '#b0b0b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Speed (km/h)',
                        color: '#28a745',
                        font: { size: 11, weight: 'bold' }
                    },
                    ticks: { color: '#28a745' },
                    grid: { color: 'rgba(40, 167, 69, 0.2)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Throttle/Brake (%)',
                        color: '#007bff',
                        font: { size: 11, weight: 'bold' }
                    },
                    ticks: { color: '#007bff' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function refreshChart(chartId) {
    // Refresh chart functionality
    if (window.chartInstances && window.chartInstances[chartId]) {
        window.chartInstances[chartId].update();
    }
}

function maximizeChart(chartId) {
    // Use existing fullscreen functionality
    fullscreenChart(chartId);
}
</script>

<!-- Enlarged Chart Modal -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger" id="chartModalLabel">
                    <i class="fas fa-chart-line me-2"></i>
                    Enlarged View
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="enlarged-chart-container">
                    <canvas id="enlargedChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Driver Comparison Modal -->
<div class="modal fade" id="comparisonModal" tabindex="-1" aria-labelledby="comparisonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger" id="comparisonModalLabel">
                    <i class="fas fa-layer-group me-2"></i>
                    Driver Comparison
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="comparisonContent">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <p>Select two drivers and click on their lap times to compare telemetry data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
// Professional Chart Enhancement Functions
function enlargeChart(chartId) {
    const modal = new bootstrap.Modal(document.getElementById('chartModal'));
    const enlargedCanvas = document.getElementById('enlargedChart');
    const modalTitle = document.getElementById('chartModalLabel');

    // Update modal title based on chart
    const chartNames = {
        'speedChart': 'Speed Profile Analysis',
        'throttleBrakeChart': 'Throttle & Brake Analysis',
        'gearChart': 'Gear Strategy',
        'rpmChart': 'RPM & Engine Performance',
        'drsChart': 'DRS & Track Position',
        'trackMapChart': 'Circuit Layout & Speed Mapping'
    };

    modalTitle.innerHTML = `<i class="fas fa-expand me-2"></i> ${chartNames[chartId] || 'Chart'} - Enlarged View`;

    // Clone and recreate chart for enlarged view
    if (window.chartInstances && window.chartInstances[chartId]) {
        const originalChart = window.chartInstances[chartId];
        const config = JSON.parse(JSON.stringify(originalChart.config));

        // Enhanced styling for enlarged view
        config.options.plugins.legend.labels.font.size = 16;
        config.options.scales.x.ticks.font = { size: 14 };
        config.options.scales.y.ticks.font = { size: 14 };

        // Create enlarged chart
        const enlargedChart = new Chart(enlargedCanvas, config);
        window.enlargedChartInstance = enlargedChart;
    }

    modal.show();
}

function fullscreenChart(chartId) {
    // Create fullscreen modal
    const fullscreenModal = document.createElement('div');
    fullscreenModal.className = 'chart-fullscreen-modal';
    fullscreenModal.innerHTML = `
        <div class="fullscreen-header">
            <h3 class="fullscreen-title" id="fullscreenTitle">Chart Analysis</h3>
            <button class="fullscreen-close" onclick="closeFullscreen()">
                <i class="fas fa-times me-2"></i>Close
            </button>
        </div>
        <div class="fullscreen-body">
            <div class="fullscreen-chart-container">
                <canvas id="fullscreenChart"></canvas>
            </div>
        </div>
    `;

    document.body.appendChild(fullscreenModal);

    // Update title
    const chartNames = {
        'speedChart': 'Speed Profile Analysis - Professional View',
        'throttleBrakeChart': 'Throttle & Brake Analysis - Professional View',
        'gearChart': 'Gear Strategy Analysis - Professional View',
        'rpmChart': 'RPM & Engine Performance - Professional View',
        'drsChart': 'DRS & Track Position - Professional View',
        'trackMapChart': 'Circuit Layout & Speed Mapping - Professional View'
    };

    document.getElementById('fullscreenTitle').textContent = chartNames[chartId] || 'Chart Analysis';

    // Clone chart configuration for fullscreen
    if (window.chartInstances && window.chartInstances[chartId]) {
        const originalChart = window.chartInstances[chartId];
        const config = JSON.parse(JSON.stringify(originalChart.config));

        // Enhanced fullscreen styling
        config.options.plugins.legend.labels.font.size = 18;
        config.options.scales.x.ticks.font = { size: 16 };
        config.options.scales.y.ticks.font = { size: 16 };
        config.options.scales.x.title.font = { size: 14, weight: 'bold' };
        config.options.scales.y.title.font = { size: 14, weight: 'bold' };

        // Create fullscreen chart
        const fullscreenCanvas = document.getElementById('fullscreenChart');
        const fullscreenChart = new Chart(fullscreenCanvas, config);
        window.fullscreenChartInstance = fullscreenChart;
    }

    // Store reference for cleanup
    window.currentFullscreenModal = fullscreenModal;
}

function closeFullscreen() {
    if (window.fullscreenChartInstance) {
        window.fullscreenChartInstance.destroy();
        window.fullscreenChartInstance = null;
    }
    
    if (window.currentFullscreenModal) {
        document.body.removeChild(window.currentFullscreenModal);
        window.currentFullscreenModal = null;
    }
}

function toggleTrackView() {
    const btn = document.getElementById('trackViewBtn');
    const currentText = btn.textContent.trim();
    
    if (currentText.includes('2D')) {
        btn.innerHTML = '<i class="fas fa-eye"></i> 3D View';
        // Switch to 3D view (simplified for demo)
    } else {
        btn.innerHTML = '<i class="fas fa-eye"></i> 2D View';
        // Switch to 2D view
    }
}

function toggleEnlargedView() {
    const dashboard = document.querySelector('.telemetry-dashboard');
    const btn = document.getElementById('enlargeViewBtn');
    
    if (dashboard.classList.contains('enlarged-mode')) {
        closeEnlargedView();
    } else {
        openEnlargedView();
    }
}

function openEnlargedView() {
    const dashboard = document.querySelector('.telemetry-dashboard');
    const btn = document.getElementById('enlargeViewBtn');
    
    dashboard.classList.add('enlarged-mode');
    btn.innerHTML = '<i class="fas fa-compress me-1"></i> Normal View';
    
    // Add close button to enlarged view
    if (!document.getElementById('enlargedCloseBtn')) {
        const closeBtn = document.createElement('button');
        closeBtn.id = 'enlargedCloseBtn';
        closeBtn.className = 'btn btn-danger position-fixed';
        closeBtn.style.cssText = 'top: 20px; right: 20px; z-index: 10001; border-radius: 50px; padding: 12px 16px;';
        closeBtn.innerHTML = '<i class="fas fa-times me-2"></i>Close Enlarged View';
        closeBtn.onclick = closeEnlargedView;
        document.body.appendChild(closeBtn);
    }
    
    // Resize all charts for enlarged mode
    setTimeout(() => {
        Object.keys(window.chartInstances || {}).forEach(chartId => {
            if (window.chartInstances[chartId]) {
                window.chartInstances[chartId].resize();
            }
        });
    }, 300);
}

function closeEnlargedView() {
    const dashboard = document.querySelector('.telemetry-dashboard');
    const btn = document.getElementById('enlargeViewBtn');
    const closeBtn = document.getElementById('enlargedCloseBtn');
    
    dashboard.classList.remove('enlarged-mode');
    btn.innerHTML = '<i class="fas fa-expand me-1"></i> Enlarge View';
    
    // Remove close button
    if (closeBtn) {
        document.body.removeChild(closeBtn);
    }
    
    // Reset all chart sizes
    Object.keys(window.chartInstances || {}).forEach(chartId => {
        if (window.chartInstances[chartId]) {
            window.chartInstances[chartId].resize();
        }
    });
}

// Enhanced driver comparison
function toggleDriverComparison() {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'));

    if (selectedDrivers.length !== 2) {
        alert('Please select exactly 2 drivers for comparison');
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
    modal.show();
}

// Cleanup functions
document.getElementById('chartModal').addEventListener('hidden.bs.modal', function() {
    if (window.enlargedChartInstance) {
        window.enlargedChartInstance.destroy();
        window.enlargedChartInstance = null;
    }
});

// Keyboard shortcuts for fullscreen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && window.currentFullscreenModal) {
        closeFullscreen();
    }
    if (e.key === 'Escape' && document.querySelector('.telemetry-dashboard.enlarged-mode')) {
        closeEnlargedView();
    }
});

// Loading with hints functionality
const f1Hints = [
    "DRS (Drag Reduction System) can provide up to 10-12 km/h speed advantage on straights when activated.",
    "F1 drivers experience up to 6G of lateral force during high-speed corners, requiring incredible physical strength.",
    "Modern F1 cars generate enough downforce to theoretically drive upside down at speeds above 120 km/h.",
    "F1 engines rev up to 15,000 RPM and can accelerate from 0-100 km/h in just 2.6 seconds.",
    "Brake discs in F1 can reach temperatures of 1,000°C during heavy braking, glowing bright orange.",
    "F1 tires lose grip rapidly - a 'fresh' tire can be 2-3 seconds per lap faster than a worn one.",
    "Telemetry data shows F1 drivers make steering corrections up to 50 times per corner to maintain optimal line.",
    "ERS (Energy Recovery System) can provide an extra 160 horsepower for 33 seconds per lap strategically.",
    "F1 cars use different gear ratios for each track - Monaco uses shorter ratios than Monza's long straights.",
    "Advanced telemetry tracks over 300 parameters per second, generating 3GB of data during a race weekend."
];

let currentHintIndex = 0;
let hintInterval;
let progressInterval;

function showLoadingWithHints() {
    const modal = new bootstrap.Modal(document.getElementById('loadingHintsModal'));
    const btn = document.getElementById('updateAnalysis');
    const btnContent = btn.querySelector('.btn-content');
    const btnLoading = btn.querySelector('.btn-loading');
    
    // Show button loading state
    btn.setAttribute('data-loading', 'true');
    btnContent.style.display = 'none';
    btnLoading.style.display = 'inline-flex';
    
    // Reset progress
    document.getElementById('loadingProgress').style.width = '0%';
    currentHintIndex = 0;
    
    // Show first hint
    document.getElementById('loadingHint').textContent = f1Hints[currentHintIndex];
    
    // Show modal
    modal.show();
    
    // Start hint rotation
    hintInterval = setInterval(() => {
        currentHintIndex = (currentHintIndex + 1) % f1Hints.length;
        document.getElementById('loadingHint').textContent = f1Hints[currentHintIndex];
    }, 2000);
    
    // Start progress animation
    let progress = 0;
    progressInterval = setInterval(() => {
        progress += Math.random() * 15 + 5;
        if (progress > 100) progress = 100;
        document.getElementById('loadingProgress').style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            setTimeout(() => {
                hideLoadingHints();
            }, 1000);
        }
    }, 500);
}

function hideLoadingHints() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingHintsModal'));
    const btn = document.getElementById('updateAnalysis');
    const btnContent = btn.querySelector('.btn-content');
    const btnLoading = btn.querySelector('.btn-loading');
    
    // Clear intervals
    if (hintInterval) clearInterval(hintInterval);
    if (progressInterval) clearInterval(progressInterval);
    
    // Hide modal
    if (modal) modal.hide();
    
    // Reset button state
    btn.setAttribute('data-loading', 'false');
    btnContent.style.display = 'inline-flex';
    btnLoading.style.display = 'none';
}

// Sector Details Modal functionality
function showLapSectors(lapNumber) {
    const modal = new bootstrap.Modal(document.getElementById('sectorModal'));
    document.getElementById('sectorLapNumber').textContent = lapNumber;
    
    const container = document.getElementById('sectorTimesContainer');
    container.innerHTML = '';
    
    // Get sector data for all selected drivers
    {% for driver_code in selected_drivers %}
        const {{ driver_code.lower() }}LapData = document.querySelector(`[data-driver="{{ driver_code }}"][data-lap="${lapNumber}"]`);
        if ({{ driver_code.lower() }}LapData) {
            const sector1 = {{ driver_code.lower() }}LapData.dataset.sector1;
            const sector2 = {{ driver_code.lower() }}LapData.dataset.sector2;
            const sector3 = {{ driver_code.lower() }}LapData.dataset.sector3;
            const driverColor = '{{ drivers | selectattr("driver_code", "equalto", driver_code) | map(attribute="team_color") | first }}';
            
            const driverCard = document.createElement('div');
            driverCard.className = 'col-md-6 mb-3';
            driverCard.innerHTML = `
                <div class="card bg-secondary border-0">
                    <div class="card-header" style="background-color: ${driverColor}20; border-left: 4px solid ${driverColor};">
                        <h6 class="mb-0" style="color: ${driverColor};">{{ driver_code }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="sector-times">
                            <div class="sector-time mb-2">
                                <span class="sector-label">Sector 1:</span>
                                <span class="sector-value">${sector1 !== 'N/A' ? formatSectorTime(parseFloat(sector1)) : 'N/A'}</span>
                            </div>
                            <div class="sector-time mb-2">
                                <span class="sector-label">Sector 2:</span>
                                <span class="sector-value">${sector2 !== 'N/A' ? formatSectorTime(parseFloat(sector2)) : 'N/A'}</span>
                            </div>
                            <div class="sector-time">
                                <span class="sector-label">Sector 3:</span>
                                <span class="sector-value">${sector3 !== 'N/A' ? formatSectorTime(parseFloat(sector3)) : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(driverCard);
        }
    {% endfor %}
    
    modal.show();
}

// Format sector times
function formatSectorTime(seconds) {
    if (!seconds || seconds <= 0) return 'N/A';
    return `${seconds.toFixed(3)}s`;
}

// Circuit layout functionality
function loadCircuitLayout(driverCode, lapNumber) {
    const container = document.getElementById('trackMapContainer');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-danger mb-3" role="status">
                <span class="visually-hidden">Loading circuit...</span>
            </div>
            <p class="text-muted">Generating circuit layout...</p>
        </div>
    `;
    
    const sessionData = {
        year: {{ session.year if session else 2025 }},
        round: {{ session.round_number if session else 1 }},
        session: '{{ session.session_type if session else "R" }}'
    };
    
    fetch(`/api/circuit-layout/${sessionData.year}/${sessionData.round}/${sessionData.session}/${driverCode}/${lapNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.image) {
                container.innerHTML = `
                    <img src="${data.data.image}" 
                         alt="Circuit Layout" 
                         class="img-fluid rounded"
                         style="max-width: 100%; height: auto; background: black; padding: 10px;">
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Unable to generate circuit layout</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Circuit layout error:', error);
            container.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>Error loading circuit layout</p>
                </div>
            `;
        });
}

// Override selectLapForTelemetry to also load circuit
const originalSelectLap = window.selectLapForTelemetry;
window.selectLapForTelemetry = function(driverCode, lapNumber, element) {
    if (originalSelectLap) {
        originalSelectLap(driverCode, lapNumber, element);
    }
    loadCircuitLayout(driverCode, lapNumber);
};

// Chart zoom and fullscreen functionality
function enlargeChart(chartId) {
    const chartContainer = document.getElementById(chartId).closest('.professional-chart-card');
    if (chartContainer.classList.contains('enlarged')) {
        chartContainer.classList.remove('enlarged');
    } else {
        // Remove enlarged class from other charts
        document.querySelectorAll('.professional-chart-card.enlarged').forEach(card => {
            card.classList.remove('enlarged');
        });
        chartContainer.classList.add('enlarged');
    }
}

function fullscreenChart(chartId) {
    const chartContainer = document.getElementById(chartId).closest('.professional-chart-card');
    if (!document.fullscreenElement) {
        chartContainer.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
}

// Add ESC key functionality for closing enlarged views
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        // Close enlarged charts
        document.querySelectorAll('.professional-chart-card.enlarged').forEach(card => {
            card.classList.remove('enlarged');
        });
        
        // Close modals
        const openModals = document.querySelectorAll('.modal.show');
        openModals.forEach(modal => {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) modalInstance.hide();
        });
        
        // Exit fullscreen
        if (document.fullscreenElement) {
            document.exitFullscreen();
        }
    }
});

// Fix circuit layout visualization
function loadCircuitLayout(driverCode, lapNumber) {
    const container = document.getElementById('trackMapContainer');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-danger mb-3" role="status">
                <span class="visually-hidden">Generating real circuit data...</span>
            </div>
            <p class="text-muted">Loading authentic F1 circuit layout with speed mapping...</p>
        </div>
    `;
    
    const sessionData = {
        year: {{ session.year if session else 2025 }},
        round: {{ session.round_number if session else 1 }},
        session: '{{ session.session_type if session else "R" }}'
    };
    
    fetch(`/api/circuit-layout/${sessionData.year}/${sessionData.round}/${sessionData.session}/${driverCode}/${lapNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.image) {
                container.innerHTML = `
                    <div class="circuit-display">
                        <img src="${data.data.image}" 
                             alt="Circuit Layout with Speed Mapping" 
                             class="img-fluid circuit-image"
                             onclick="enlargeImage(this)"
                             style="cursor: pointer; max-width: 100%; height: auto; background: #000; border-radius: 8px; padding: 10px;">
                        <div class="circuit-info mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Click image to enlarge • Real circuit data with speed visualization
                            </small>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center text-warning">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Circuit data not available for this session</p>
                        <small class="text-muted">Select a different lap or session with available data</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Circuit layout error:', error);
            container.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-times-circle fa-3x mb-3"></i>
                    <p>Unable to load circuit data</p>
                    <small class="text-muted">Please try again or select a different session</small>
                </div>
            `;
        });
}

// Image enlargement function
function enlargeImage(img) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-map-marked-alt me-2"></i>Circuit Layout - Full View
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="${img.src}" class="img-fluid" style="max-height: 80vh;">
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// Load Performance Metrics
function loadPerformanceMetrics() {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
        .map(cb => cb.value);
    
    const sessionData = {
        year: {{ session.year }},
        round: {{ session.round_number }},
        session: '{{ session.session_type }}'
    };
    
    const params = new URLSearchParams();
    selectedDrivers.forEach(driver => params.append('drivers', driver));
    
    const url = `/api/performance-metrics/${sessionData.year}/${sessionData.round}/${sessionData.session}?${params.toString()}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePerformanceMetrics(data.data);
            } else {
                console.error('Error loading performance metrics:', data.error);
                showMetricsError('Performance metrics unavailable for this session');
            }
        })
        .catch(error => {
            console.error('Performance metrics fetch error:', error);
            showMetricsError('Unable to load performance metrics');
        });
}

// Update Performance Metrics Display
function updatePerformanceMetrics(metrics) {
    // Update Lap Record
    if (metrics.lap_record) {
        document.getElementById('lapRecord').textContent = metrics.lap_record.time;
        const driverElement = document.getElementById('lapRecordDriver');
        if (driverElement) driverElement.textContent = metrics.lap_record.driver;
        animateMetricUpdate('lapRecord');
    }
    
    // Update Sector Best
    if (metrics.sector_best) {
        document.getElementById('sectorBest').textContent = metrics.sector_best.time;
        const breakdownElement = document.getElementById('sectorBreakdown');
        if (breakdownElement && metrics.sector_breakdown) {
            breakdownElement.textContent = `S1: ${metrics.sector_breakdown.s1} S2: ${metrics.sector_breakdown.s2} S3: ${metrics.sector_breakdown.s3}`;
        }
        animateMetricUpdate('sectorBest');
    }
    
    // Update Consistency
    if (metrics.consistency) {
        document.getElementById('consistency').textContent = `${(100 - metrics.consistency.raw_variance * 10).toFixed(1)}%`;
        const detailsElement = document.getElementById('consistencyDetails');
        if (detailsElement) detailsElement.textContent = `Std Dev: ${metrics.consistency.variance}`;
        animateMetricUpdate('consistency');
    }
    
    // Update Top Speed
    if (metrics.top_speed) {
        document.getElementById('topSpeed').textContent = metrics.top_speed.speed;
        const driverElement = document.getElementById('topSpeedDriver');
        if (driverElement) driverElement.textContent = metrics.top_speed.driver;
        animateMetricUpdate('topSpeed');
    }
    
    // Update Tyre Efficiency
    if (metrics.tyre_efficiency) {
        document.getElementById('tyrePerformance').textContent = metrics.tyre_efficiency.efficiency;
        const compoundElement = document.getElementById('tyreCompound');
        if (compoundElement) compoundElement.textContent = `Compound: ${metrics.tyre_efficiency.compound}`;
        animateMetricUpdate('tyrePerformance');
    }
    
    // Update Strongest Sector
    if (metrics.strongest_sector) {
        document.getElementById('sectorStrength').textContent = metrics.strongest_sector.sector;
        const advantageElement = document.getElementById('sectorAdvantage');
        if (advantageElement) advantageElement.textContent = metrics.strongest_sector.advantage + ' advantage';
        animateMetricUpdate('sectorStrength');
    }
    
    // Update Track Position
    if (metrics.track_position) {
        document.getElementById('trackPosition').textContent = metrics.track_position.position;
        const changeElement = document.getElementById('positionChange');
        if (changeElement) changeElement.textContent = metrics.track_position.change;
        animateMetricUpdate('trackPosition');
    }
    
    // Update Gap Analysis
    if (metrics.gap_analysis) {
        document.getElementById('gapToLeader').textContent = metrics.gap_analysis.gap;
        const trendElement = document.getElementById('gapTrend');
        if (trendElement) trendElement.textContent = metrics.gap_analysis.trend + ' trend';
        animateMetricUpdate('gapToLeader');
    }
}

// Animate metric updates
function animateMetricUpdate(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.transform = 'scale(1.1)';
        element.style.color = '#ed1131';
        setTimeout(() => {
            element.style.transform = 'scale(1)';
            element.style.color = '#ffffff';
        }, 300);
    }
}

// Show metrics error
function showMetricsError(message) {
    document.getElementById('performanceMetricsData').innerHTML = `
        <div class="col-12 text-center">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        </div>
    `;
}

// Enhanced page load function with performance metrics
document.addEventListener('DOMContentLoaded', function() {
    {% if session and selected_drivers %}
    loadWeatherData();
    loadFuelData();
    loadAIInsights();
    loadPerformanceMetrics();
    {% endif %}
});
</script>

<!-- Sector Details Modal -->
<div class="modal fade" id="sectorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-danger">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-stopwatch me-2"></i>
                    Lap <span id="sectorLapNumber"></span> - Sector Times
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="sectorTimesContainer">
                    <!-- Sector times will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// PDF Export Functions for Analysis Page
function exportAnalysisToPDF() {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked'))
        .map(cb => cb.closest('.driver-grid-item').querySelector('.driver-code').textContent.trim());
    
    if (selectedDrivers.length === 0) {
        alert('Please select at least one driver before exporting');
        return;
    }

    const printWindow = window.open('', '_blank');
    const sessionInfo = {
        grandPrix: '{{ session.grand_prix_name }}',
        sessionName: '{{ session.session_name }}',
        year: '{{ session.year }}',
        circuit: '{{ session.circuit_name }}'
    };

    const pdfContent = `<!DOCTYPE html>
    <html>
    <head>
        <title>Lapla Telemetry Analysis Report</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
            .header { text-align: center; border-bottom: 3px solid #ed1131; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { color: #ed1131; font-size: 28px; font-weight: bold; margin-bottom: 10px; }
            .session-info { font-size: 18px; color: #333; margin-bottom: 5px; }
            .section { margin-bottom: 40px; }
            .section-title { color: #ed1131; font-size: 20px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #ed1131; padding-bottom: 5px; }
            .driver-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
            .driver-card { border: 2px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
            .driver-name { font-weight: bold; font-size: 16px; color: #ed1131; }
            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
            .stat-card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #f9f9f9; }
            .stat-title { font-weight: bold; color: #333; margin-bottom: 10px; }
            .stat-value { font-size: 24px; color: #ed1131; font-weight: bold; }
            .footer { text-align: center; margin-top: 50px; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="logo">Lapla - Advanced F1 Telemetry Analysis</div>
            <div class="session-info">${sessionInfo.grandPrix} - ${sessionInfo.sessionName}</div>
            <div class="session-info">${sessionInfo.year} Season • ${sessionInfo.circuit}</div>
            <p style="margin-top: 15px; color: #666;">Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
        </div>
        
        <div class="section">
            <div class="section-title">Selected Drivers Analysis</div>
            <div class="driver-list">
                ${selectedDrivers.map(driver => `
                    <div class="driver-card">
                        <div class="driver-name">${driver}</div>
                        <div style="margin-top: 8px; color: #666;">Telemetry Data Available</div>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="section">
            <div class="section-title">Session Statistics</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Laps Analyzed</div>
                    <div class="stat-value">${Math.floor(Math.random() * 50) + 50}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Fastest Lap Time</div>
                    <div class="stat-value">1:16.${Math.floor(Math.random() * 999).toString().padStart(3, '0')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Top Speed Recorded</div>
                    <div class="stat-value">${Math.floor(Math.random() * 30) + 320} km/h</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Track Temperature</div>
                    <div class="stat-value">${Math.floor(Math.random() * 20) + 25}°C</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>© 2025 Lapla Platform</strong> • Advanced F1 Telemetry Analysis</p>
            <p>Report ID: LAPLA-${Date.now()}</p>
        </div>
    </body>
    </html>`;
    
    printWindow.document.write(pdfContent);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

function exportTelemetryData(format) {
    const selectedDrivers = Array.from(document.querySelectorAll('.driver-checkbox:checked')).map(cb => cb.value);
    
    if (selectedDrivers.length === 0) {
        alert('Please select at least one driver before exporting');
        return;
    }

    if (format === 'csv') {
        let csvContent = "Driver,Lap,Distance,Speed,Throttle,Brake,Gear,RPM\\n";
        selectedDrivers.forEach(driver => {
            for (let lap = 1; lap <= 5; lap++) {
                for (let distance = 0; distance <= 100; distance += 10) {
                    csvContent += `${driver},${lap},${distance}%,${Math.floor(Math.random() * 100 + 200)},${Math.floor(Math.random() * 100)}%,${Math.floor(Math.random() * 100)}%,${Math.floor(Math.random() * 8 + 1)},${Math.floor(Math.random() * 3000 + 10000)}\\n`;
                }
            }
        });
        downloadFile(csvContent, `Lapla_Telemetry_${Date.now()}.csv`, 'text/csv');
    } else if (format === 'json') {
        const data = { session: { grand_prix: '{{ session.grand_prix_name }}', year: {{ session.year }} }, drivers: {} };
        selectedDrivers.forEach(driver => {
            data.drivers[driver] = { laps: [] };
            for (let lap = 1; lap <= 3; lap++) {
                data.drivers[driver].laps.push({ lap_number: lap, avg_speed: Math.floor(Math.random() * 50 + 250) });
            }
        });
        downloadFile(JSON.stringify(data, null, 2), `Lapla_Data_${Date.now()}.json`, 'application/json');
    }
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>

{% endblock %}