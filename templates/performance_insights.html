{% extends "base.html" %}

{% block title %}Performance Insights - Lapla{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">
                <i class="fas fa-chart-line me-3"></i>
                Performance Insights
            </h1>
            <p class="page-subtitle text-muted">
                Advanced performance analysis and strategic insights engine
            </p>
        </div>
        <div class="col-auto">
            <div class="page-actions">
                <button class="btn btn-outline-secondary me-2" onclick="refreshInsights()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportPerformanceData('pdf')">Performance Report (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPerformanceData('excel')">Detailed Analysis (Excel)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPerformanceData('csv')">Data Export (CSV)</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Controls -->
<div class="controls-section mb-4">
    <div class="card">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="seasonSelect" class="form-label">Season</label>
                    <select class="form-select" id="seasonSelect" onchange="loadRaces()">
                        {% for year in years %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="roundSelect" class="form-label">Race</label>
                    <select class="form-select" id="roundSelect" onchange="loadSessions()">
                        <option value="">Select Race</option>
                        {% for race in schedule %}
                        <option value="{{ race.round }}">R{{ race.round }} - {{ race.event_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sessionSelect" class="form-label">Session</label>
                    <select class="form-select" id="sessionSelect">
                        <option value="">Select Session</option>
                        <option value="FP1">Free Practice 1</option>
                        <option value="FP2">Free Practice 2</option>
                        <option value="FP3">Free Practice 3</option>
                        <option value="SQ">Sprint Qualifying</option>
                        <option value="S">Sprint</option>
                        <option value="Q">Qualifying</option>
                        <option value="R">Race</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="generateInsights()">
                        <i class="fas fa-bolt me-1"></i>Analyze
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Loading Animation with F1 Hints -->
<div id="loadingInsights" class="loading-modal" style="display: none;">
    <div class="loading-overlay">
        <div class="loading-content">
            <div class="f1-loader">
                <div class="f1-car"></div>
                <div class="track-line"></div>
            </div>
            <h4 class="loading-title">Analyzing Performance Data</h4>
            <div class="loading-hint-container">
                <div id="loadingHint" class="loading-hint">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    <span id="hintText">Loading performance insights...</span>
                </div>
            </div>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Insights Display -->
<div id="insightsContainer">
    <!-- Race Overview -->
    <div class="section mb-4" id="raceOverview" style="display: none;">
        <div class="section-header mb-3">
            <h3 class="section-title">Race Overview Analysis</h3>
        </div>
        
        <div class="row">
            <div class="col-lg-8">
                <div class="card insights-card">
                    <div class="card-body">
                        <div class="row" id="overviewMetrics">
                            <!-- Metrics will be populated by JavaScript -->
                        </div>
                        
                        <div id="winnerInfo" class="winner-info mt-3 p-3 bg-success bg-opacity-10 rounded" style="display: none;">
                            <h6 class="text-success mb-1">
                                <i class="fas fa-trophy me-2"></i>Race Winner
                            </h6>
                            <div id="winnerDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card" id="fastestLapCard" style="display: none;">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3">
                            <i class="fas fa-bolt me-2"></i>Fastest Lap
                        </h6>
                        <div class="fastest-lap-info" id="fastestLapInfo">
                            <!-- Fastest lap info will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Driver Performance Analysis -->
    <div class="section mb-4" id="driverPerformance" style="display: none;">
        <div class="section-header mb-3">
            <h3 class="section-title">Driver Performance Analysis</h3>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover driver-performance-table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Driver</th>
                                <th>Team</th>
                                <th>Best Lap</th>
                                <th>Avg Lap</th>
                                <th>Consistency</th>
                                <th>Performance Rating</th>
                            </tr>
                        </thead>
                        <tbody id="driverPerformanceTable">
                            <!-- Driver performance data will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="section mb-4" id="performanceMetrics" style="display: none;">
        <div class="section-header mb-3">
            <h3 class="section-title">Performance Metrics</h3>
        </div>
        
        <div class="row" id="metricsGrid">
            <!-- Performance metrics cards will be populated -->
        </div>
    </div>
    
    <!-- Strategic Insights -->
    <div class="section mb-4" id="strategicInsights" style="display: none;">
        <div class="section-header mb-3">
            <h3 class="section-title">Strategic Insights</h3>
        </div>
        
        <div class="row" id="insightsGrid">
            <!-- Strategic insights cards will be populated -->
        </div>
    </div>
</div>

<style>
.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
}

.insights-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
}

.section-title {
    color: #333;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.section-title i {
    color: #667eea;
}

.metric-item {
    text-align: center;
    padding: 1rem;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.metric-label {
    font-size: 0.875rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.driver-performance-table {
    font-size: 0.9rem;
}

.position-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-weight: bold;
    text-align: center;
    min-width: 30px;
}

.position-1 { background: gold; color: #000; }
.position-2 { background: silver; color: #000; }
.position-3 { background: #cd7f32; color: #fff; }
.position-dnf { background: #dc3545; color: #fff; }

.performance-rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.rating-bar {
    width: 60px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.rating-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.insight-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    transition: transform 0.2s ease;
}

.insight-card:hover {
    transform: translateY(-5px);
}

.insight-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.confidence-stars {
    color: #ffd700;
}

/* Enhanced Loading Animations */
.loading-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.loading-overlay {
    text-align: center;
    color: white;
}

.loading-content {
    max-width: 500px;
    padding: 2rem;
}

.f1-loader {
    position: relative;
    width: 200px;
    height: 60px;
    margin: 0 auto 2rem;
}

.f1-car {
    position: absolute;
    top: 20px;
    left: 0;
    width: 40px;
    height: 20px;
    background: linear-gradient(45deg, #ed1131, #ff6b6b);
    border-radius: 10px;
    animation: f1Drive 3s linear infinite;
}

.f1-car::before {
    content: '';
    position: absolute;
    top: -5px;
    left: 10px;
    width: 20px;
    height: 10px;
    background: #333;
    border-radius: 5px;
}

.track-line {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, 
        #ed1131 0%, #ed1131 25%, 
        transparent 25%, transparent 50%,
        #ed1131 50%, #ed1131 75%,
        transparent 75%, transparent 100%);
    background-size: 40px 4px;
    animation: trackMove 1s linear infinite;
}

@keyframes f1Drive {
    0% { left: -40px; }
    100% { left: 200px; }
}

@keyframes trackMove {
    0% { background-position-x: 0; }
    100% { background-position-x: 40px; }
}

.loading-title {
    color: #ed1131;
    font-weight: bold;
    margin-bottom: 1rem;
}

.loading-hint-container {
    background: rgba(237, 17, 49, 0.1);
    border: 1px solid rgba(237, 17, 49, 0.3);
    border-radius: 10px;
    padding: 1rem;
    margin: 1rem 0;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-hint {
    font-size: 1.1rem;
    text-align: center;
    line-height: 1.4;
}

.loading-progress {
    width: 100%;
    height: 6px;
    background: #333;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 1rem;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ed1131, #ff6b6b, #ed1131);
    background-size: 200% 100%;
    border-radius: 3px;
    width: 0%;
    animation: progressFill 4s ease-in-out infinite, gradientMove 2s linear infinite;
}

@keyframes progressFill {
    0%, 100% { width: 0%; }
    50% { width: 100%; }
}

@keyframes gradientMove {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}
</style>

<script>
let currentYear = {{ current_year }};
let currentSchedule = {{ schedule | tojson }};

// 100 F1 Performance Hints for Loading
const f1Hints = [
    "DRS (Drag Reduction System) can provide up to 10-15 km/h speed advantage on straights",
    "F1 drivers experience up to 6G forces during heavy braking at high speeds",
    "Modern F1 cars generate enough downforce to drive upside down at 180 km/h",
    "F1 engines rev up to 15,000 RPM and produce around 1000 horsepower",
    "Brake discs can reach temperatures of 1000°C during heavy braking",
    "Tire pressure changes by 1-2 PSI during a stint due to heat buildup",
    "F1 steering wheels have over 25 buttons and switches for various controls",
    "Cars can lose 0.5-1 second per lap when stuck in dirty air behind another car",
    "ERS (Energy Recovery System) provides an additional 160 horsepower for 33 seconds per lap",
    "F1 cars accelerate from 0-100 km/h in approximately 2.6 seconds",
    
    "Gear ratios are optimized specifically for each track layout and characteristics",
    "Advanced telemetry systems monitor over 300 sensors throughout the car",
    "Pit stop tire changes can be completed in under 3 seconds by professional crews",
    "F1 drivers can lose 3-4 kg of body weight during a single race session",
    "Cars consume approximately 110 kg of fuel during a full race distance",
    "Suspension settings are adjusted in increments as small as 1mm for optimal performance",
    "F1 engines are precision-engineered to last exactly 7 race weekends",
    "Aerodynamic efficiency is measured in L/D ratios, with higher values being better",
    "Track temperature affects tire grip levels and degradation rates significantly",
    "F1 cars use carbon fiber monocoques that weigh only around 80-100 kg",
    
    "Brake-by-wire systems allow precise control over brake balance during corners",
    "Tire compounds are color-coded: soft (red), medium (yellow), hard (white)",
    "F1 drivers' reaction times are typically 0.2 seconds, faster than average humans",
    "Cars generate approximately 5000 data points per second during track sessions",
    "Optimal racing lines minimize distance while maximizing corner exit speeds",
    "F1 teams employ hundreds of engineers and data analysts for performance optimization",
    "Wind tunnel testing is limited to 320 runs per year to control development costs",
    "Gear changes in modern F1 cars take approximately 50 milliseconds",
    "Racing fuel is specially formulated for maximum energy density and efficiency",
    "F1 drivers train extensively on simulators that cost millions of dollars",
    
    "Tire degradation follows predictable patterns that teams model for strategy",
    "F1 cars have no traditional differential - they use electronic torque vectoring",
    "Radio communications between drivers and teams are encrypted for security",
    "Carbon brakes provide consistent performance but require high temperatures to work effectively",
    "F1 drivers experience rapid directional G-force changes of up to 5G in corners",
    "Advanced CFD simulations require supercomputers to model aerodynamic flow",
    "F1 engines are hybrid power units combining internal combustion with electric motors",
    "Tire warmers are used to bring tires to optimal operating temperature before sessions",
    "F1 safety cars are high-performance vehicles capable of maintaining competitive speeds",
    "Drivers' heart rates can exceed 180 BPM during intense racing situations",
    
    "Ground effect aerodynamics create a vacuum under the car for increased downforce",
    "F1 teams use predictive algorithms to optimize fuel load and tire strategy",
    "Steering feedback systems provide drivers with precise road surface information",
    "F1 cars can brake from 300 km/h to 80 km/h in approximately 4 seconds",
    "Race engineers monitor real-time telemetry to advise drivers on optimal techniques",
    "F1 gearboxes must last 6 consecutive race events to comply with regulations",
    "Aerodynamic balance affects car handling - too much rear downforce causes understeer",
    "F1 drivers use specific breathing techniques to maintain focus during races",
    "Team radios allow real-time communication of track conditions and strategy updates",
    "F1 cars use advanced materials like titanium and carbon fiber for weight reduction",
    
    "Qualifying sessions determine grid positions through elimination-style time attacks",
    "F1 power units include sophisticated energy recovery systems from braking and exhaust",
    "Drivers adjust brake balance throughout sessions as fuel load decreases",
    "F1 teams analyze driver inputs at millisecond precision for performance optimization",
    "Track evolution means lap times typically improve throughout practice sessions",
    "F1 hydraulic systems operate at extremely high pressures for precise control",
    "Teams use machine learning to predict optimal tire change timing during races",
    "F1 drivers' physical fitness rivals that of Olympic athletes in specific areas",
    "Aerodynamic updates can provide tenths of seconds improvement per lap",
    "F1 cars use semi-automatic gearboxes with paddle shifters behind the steering wheel",
    
    "Race strategy involves complex calculations of tire degradation and fuel consumption",
    "F1 engineers use advanced simulation software to test setup changes virtually",
    "Drivers practice emergency procedures extensively, including fire evacuation protocols",
    "F1 teams have dedicated meteorologists to predict weather conditions accurately",
    "Cooling systems must balance engine temperature with aerodynamic efficiency",
    "F1 drivers undergo intensive mental training to maintain concentration under pressure",
    "Teams analyze competitor telemetry data to identify performance advantages",
    "F1 cars have sophisticated traction control systems integrated into the ECU",
    "Safety systems including HANS devices protect drivers from severe head injuries",
    "F1 engineers optimize wing angles to balance downforce and drag for each circuit",
    
    "Tire pressure monitoring systems provide real-time data on tire performance",
    "F1 drivers use specialized racing suits with integrated cooling systems",
    "Teams employ biomechanical analysis to optimize driver positioning and ergonomics",
    "F1 power steering systems are tuned to provide optimal feedback and assistance",
    "Race weekend schedules are precisely timed to maximize track evolution benefits",
    "F1 teams use advanced composites in bodywork for optimal strength-to-weight ratios",
    "Drivers practice specific techniques for different weather conditions extensively",
    "F1 engines use advanced lubrication systems to minimize friction losses",
    "Teams analyze video footage frame-by-frame to identify racing line improvements",
    "F1 cars have redundant safety systems to protect against multiple failure modes",
    
    "Race control monitors all cars simultaneously using advanced tracking technology",
    "F1 drivers develop muscle memory for track layouts through extensive practice",
    "Teams use computational fluid dynamics to design optimal aerodynamic packages",
    "F1 regulations strictly control development areas to maintain competitive balance",
    "Drivers work closely with sports psychologists to optimize mental performance",
    "F1 teams employ specialized mechanics for each car subsystem",
    "Advanced data logging systems capture every aspect of car and driver performance",
    "F1 circuits are designed with specific safety features including gravel traps",
    "Teams use high-speed cameras to analyze suspension behavior in real-time",
    "F1 drivers must maintain precise racing lines while managing tire temperatures",
    
    "Pit wall engineers coordinate strategy decisions using real-time race data",
    "F1 cars use active aerodynamics that adjust automatically based on speed",
    "Driver coaching involves detailed analysis of telemetry data and video footage",
    "F1 teams have dedicated personnel for tire temperature and pressure monitoring",
    "Race engineers calculate optimal fuel loads considering multiple strategy scenarios",
    "F1 drivers practice emergency procedures including rapid car evacuation",
    "Teams use advanced materials testing to ensure component reliability under stress",
    "F1 cars have sophisticated electronic systems managing power distribution",
    "Drivers undergo regular medical assessments to ensure peak physical condition",
    "F1 teams analyze microscopic tire wear patterns to understand performance degradation",
    
    "Circuit characteristics determine optimal car setup including suspension geometry",
    "F1 drivers train their peripheral vision to monitor multiple cars simultaneously",
    "Teams use predictive modeling to anticipate component failure risks",
    "F1 cars have advanced fire suppression systems activated by driver controls",
    "Race strategy meetings involve detailed analysis of historical performance data",
    "F1 drivers practice specific techniques for overtaking in different track sections",
    "Teams monitor brake disc thickness to ensure safety margins throughout sessions",
    "F1 engines are designed to operate at maximum efficiency within specific RPM ranges",
    "Drivers work with nutritionists to optimize energy levels during long race sessions",
    "F1 teams use advanced simulation to test setup changes without track time"
];

let currentHintIndex = 0;

function loadRaces() {
    const seasonSelect = document.getElementById('seasonSelect');
    const year = parseInt(seasonSelect.value);
    currentYear = year;
    
    // Fetch races for selected year
    fetch(`/api/schedule/${year}`)
        .then(response => response.json())
        .then(data => {
            const roundSelect = document.getElementById('roundSelect');
            roundSelect.innerHTML = '<option value="">Select Race</option>';
            
            data.forEach(race => {
                const option = document.createElement('option');
                option.value = race.round;
                option.textContent = `R${race.round} - ${race.event_name}`;
                roundSelect.appendChild(option);
            });
            
            currentSchedule = data;
            
            // Clear sessions
            document.getElementById('sessionSelect').innerHTML = '<option value="">Select Session</option>';
        });
}

function loadSessions() {
    const roundSelect = document.getElementById('roundSelect');
    const sessionSelect = document.getElementById('sessionSelect');
    
    if (!roundSelect.value) {
        sessionSelect.innerHTML = '<option value="">Select Session</option>';
        return;
    }
    
    // Fetch available sessions for selected race
    fetch(`/api/sessions/${currentYear}/${roundSelect.value}`)
        .then(response => response.json())
        .then(data => {
            sessionSelect.innerHTML = '<option value="">Select Session</option>';
            
            data.available_sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.type;
                option.textContent = session.name;
                sessionSelect.appendChild(option);
            });
        });
}

function generateInsights() {
    const year = document.getElementById('seasonSelect').value;
    const round = document.getElementById('roundSelect').value;
    const session = document.getElementById('sessionSelect').value;
    
    if (!year || !round || !session) {
        alert('Please select a season, race, and session');
        return;
    }
    
    // Show enhanced loading with hints
    showEnhancedLoading();
    document.getElementById('insightsContainer').style.display = 'none';
    
    // Fetch insights data
    fetch(`/api/performance-insights/${year}/${round}/${session}`)
        .then(response => response.json())
        .then(data => {
            setTimeout(() => {
                hideEnhancedLoading();
                displayInsights(data.data);
                document.getElementById('insightsContainer').style.display = 'block';
            }, 3000); // Show loading for at least 3 seconds
        })
        .catch(error => {
            console.error('Error fetching insights:', error);
            hideEnhancedLoading();
            alert('Error loading performance insights');
        });
}

function showEnhancedLoading() {
    document.getElementById('loadingInsights').style.display = 'flex';
    currentHintIndex = 0;
    startHintRotation();
}

function hideEnhancedLoading() {
    document.getElementById('loadingInsights').style.display = 'none';
    if (window.hintInterval) {
        clearInterval(window.hintInterval);
    }
}

function startHintRotation() {
    // Show first hint immediately
    updateHint();
    
    // Rotate hints every 2 seconds
    window.hintInterval = setInterval(() => {
        currentHintIndex = (currentHintIndex + 1) % f1Hints.length;
        updateHint();
    }, 2000);
}

function updateHint() {
    const hintElement = document.getElementById('hintText');
    hintElement.style.opacity = '0';
    
    setTimeout(() => {
        hintElement.textContent = f1Hints[currentHintIndex];
        hintElement.style.opacity = '1';
    }, 300);
}

// Load driver fastest laps data
function loadFastestLapsData() {
    const year = document.getElementById('seasonSelect').value;
    const round = document.getElementById('roundSelect').value;
    const session = document.getElementById('sessionSelect').value;
    
    if (!year || !round || !session) return;
    
    const fastestLapsUrl = `/api/fastest-laps/${year}/${round}/${session}?drivers=VER&drivers=LEC&drivers=HAM&drivers=RUS&drivers=NOR&drivers=PIA`;
    
    fetch(fastestLapsUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFastestLapsData(data.data);
            } else {
                displayFastestLapsError(data.error);
            }
        })
        .catch(error => {
            console.error('Fastest laps data error:', error);
            displayFastestLapsError('Failed to load fastest lap data');
        });
}

function displayFastestLapsData(fastestLapsData) {
    const container = document.getElementById('fastestLapsData');
    
    let html = '<div class="fastest-laps-grid">';
    
    Object.entries(fastestLapsData).forEach(([driverCode, driverData]) => {
        html += `
            <div class="driver-fastest-laps-card">
                <div class="driver-header">
                    <span class="driver-code">${driverCode}</span>
                    <span class="fastest-time">${driverData.fastest_time}</span>
                </div>
                <div class="lap-times-list">`;
        
        driverData.fastest_laps.slice(0, 5).forEach((lap, index) => {
            html += `
                <div class="lap-time-item">
                    <span class="lap-position">${index + 1}.</span>
                    <span class="lap-time">${lap.time}</span>
                    <span class="lap-compound compound-${lap.compound.toLowerCase()}">${lap.compound}</span>
                    <span class="lap-number">L${lap.lap_number}</span>
                </div>`;
        });
        
        html += `
                </div>
                <div class="total-laps">
                    <small class="text-muted">Total Laps: ${driverData.total_laps}</small>
                </div>
            </div>`;
    });
    
    html += '</div>';
    
    // Add styling for fastest laps display
    html += `
    <style>
    .fastest-laps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .driver-fastest-laps-card {
        background: linear-gradient(145deg, #2d3748, #1a202c);
        border: 1px solid #4a5568;
        border-radius: 8px;
        padding: 1rem;
        transition: transform 0.2s ease;
    }
    
    .driver-fastest-laps-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 65, 0.1);
    }
    
    .driver-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #4a5568;
    }
    
    .driver-code {
        font-weight: bold;
        font-size: 1.1rem;
        color: #00ff41;
    }
    
    .fastest-time {
        font-weight: bold;
        color: #ffd700;
        font-size: 1rem;
    }
    
    .lap-times-list {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .lap-time-item {
        display: grid;
        grid-template-columns: 20px 1fr auto auto;
        gap: 0.5rem;
        align-items: center;
        padding: 0.25rem;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }
    
    .lap-time-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .lap-position {
        font-size: 0.8rem;
        color: #a0aec0;
    }
    
    .lap-time {
        font-family: monospace;
        font-size: 0.9rem;
        color: #e2e8f0;
    }
    
    .lap-compound {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
    }
    
    .compound-soft {
        background-color: #ff3333;
        color: white;
    }
    
    .compound-medium {
        background-color: #ffd700;
        color: black;
    }
    
    .compound-hard {
        background-color: #ffffff;
        color: black;
    }
    
    .lap-number {
        font-size: 0.75rem;
        color: #a0aec0;
    }
    
    .total-laps {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #4a5568;
        text-align: center;
    }
    </style>`;
    
    container.innerHTML = html;
    
    // Hide loading animation and show data
    document.getElementById('fastestLapsLoadingAnimation').style.display = 'none';
    document.getElementById('fastestLapsData').style.display = 'block';
    
    // Auto-hide after 2 seconds (remove if you want persistent display)
    setTimeout(() => {
        document.getElementById('fastestLapsLoadingAnimation').style.display = 'none';
    }, 2000);
}

function displayFastestLapsError(error) {
    const errorContainer = document.getElementById('fastestLapsError');
    errorContainer.innerHTML = `
        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
        <p>Unable to load fastest lap data</p>
        <small>${error}</small>
    `;
    
    document.getElementById('fastestLapsLoadingAnimation').style.display = 'none';
    document.getElementById('fastestLapsError').style.display = 'block';
}

function refreshFastestLaps() {
    document.getElementById('fastestLapsData').style.display = 'none';
    document.getElementById('fastestLapsError').style.display = 'none';
    document.getElementById('fastestLapsLoadingAnimation').style.display = 'block';
    
    loadFastestLapsData();
}

// PDF Export Functionality
function exportPerformanceData(format) {
    const year = document.getElementById('seasonSelect').value;
    const round = document.getElementById('roundSelect').value;
    const session = document.getElementById('sessionSelect').value;
    
    if (!year || !round || !session) {
        alert('Please select a session first before exporting');
        return;
    }
    
    if (format === 'pdf') {
        exportToPDF();
    } else if (format === 'excel') {
        exportToExcel();
    } else if (format === 'csv') {
        exportToCSV();
    }
}

function exportToPDF() {
    // Generate PDF using browser's print functionality
    const printWindow = window.open('', '_blank');
    const currentData = getCurrentInsightsData();
    
    const pdfContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Lapla Performance Report</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; border-bottom: 2px solid #ed1131; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { color: #ed1131; font-size: 24px; font-weight: bold; }
            .section { margin-bottom: 30px; }
            .section-title { color: #ed1131; font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
            .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
            .metric-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
            .metric-title { font-weight: bold; color: #333; }
            .metric-value { font-size: 18px; color: #ed1131; font-weight: bold; }
            .driver-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            .driver-table th, .driver-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .driver-table th { background-color: #f5f5f5; }
            .insight-item { margin-bottom: 15px; padding: 10px; border-left: 4px solid #ed1131; background-color: #f9f9f9; }
            .footer { text-align: center; margin-top: 40px; font-size: 12px; color: #666; }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="logo">Lapla - Advanced F1 Telemetry Analysis</div>
            <h2>Performance Insights Report</h2>
            <p>Generated on ${new Date().toLocaleDateString()} • ${document.getElementById('seasonSelect').value} Season</p>
        </div>
        
        <div class="section">
            <div class="section-title">Race Overview</div>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-title">Total Drivers</div>
                    <div class="metric-value">${currentData?.race_overview?.total_drivers || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Total Laps</div>
                    <div class="metric-value">${currentData?.race_overview?.total_laps || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Fastest Lap</div>
                    <div class="metric-value">${currentData?.race_overview?.fastest_lap_time || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Track Temperature</div>
                    <div class="metric-value">${currentData?.race_overview?.track_temperature || 'N/A'}°C</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Performance Metrics</div>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-title">Lap Record</div>
                    <div class="metric-value">${currentData?.performance_metrics?.lap_record || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Sector Best</div>
                    <div class="metric-value">${currentData?.performance_metrics?.sector_best || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Top Speed</div>
                    <div class="metric-value">${currentData?.performance_metrics?.top_speed || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Consistency</div>
                    <div class="metric-value">${currentData?.performance_metrics?.consistency || 'N/A'}</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Strategic Insights</div>
            ${currentData?.strategic_insights?.map(insight => `
                <div class="insight-item">
                    <strong>${insight.title}</strong><br>
                    ${insight.description}
                    <br><small>Confidence: ${insight.confidence}/5 stars</small>
                </div>
            `).join('') || '<p>No insights available</p>'}
        </div>
        
        <div class="footer">
            <p>© 2025 Lapla Platform • Advanced F1 Telemetry Analysis • Generated ${new Date().toLocaleString()}</p>
        </div>
    </body>
    </html>`;
    
    printWindow.document.write(pdfContent);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

function exportToExcel() {
    const currentData = getCurrentInsightsData();
    if (!currentData) {
        alert('No data available to export');
        return;
    }
    
    // Create CSV content for Excel compatibility
    let csvContent = "Lapla Performance Analysis Report\n";
    csvContent += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    // Race Overview
    csvContent += "RACE OVERVIEW\n";
    csvContent += "Metric,Value\n";
    csvContent += `Total Drivers,${currentData.race_overview?.total_drivers || 'N/A'}\n`;
    csvContent += `Total Laps,${currentData.race_overview?.total_laps || 'N/A'}\n`;
    csvContent += `Fastest Lap,${currentData.race_overview?.fastest_lap_time || 'N/A'}\n`;
    csvContent += `Track Temperature,${currentData.race_overview?.track_temperature || 'N/A'}°C\n\n`;
    
    // Performance Metrics
    csvContent += "PERFORMANCE METRICS\n";
    csvContent += "Metric,Value\n";
    csvContent += `Lap Record,${currentData.performance_metrics?.lap_record || 'N/A'}\n`;
    csvContent += `Sector Best,${currentData.performance_metrics?.sector_best || 'N/A'}\n`;
    csvContent += `Top Speed,${currentData.performance_metrics?.top_speed || 'N/A'}\n`;
    csvContent += `Consistency,${currentData.performance_metrics?.consistency || 'N/A'}\n\n`;
    
    // Strategic Insights
    csvContent += "STRATEGIC INSIGHTS\n";
    csvContent += "Title,Description,Confidence\n";
    currentData.strategic_insights?.forEach(insight => {
        csvContent += `"${insight.title}","${insight.description}",${insight.confidence}/5\n`;
    });
    
    downloadFile(csvContent, `Lapla_Performance_Report_${Date.now()}.csv`, 'text/csv');
}

function exportToCSV() {
    const currentData = getCurrentInsightsData();
    if (!currentData) {
        alert('No data available to export');
        return;
    }
    
    // Create simplified CSV for data analysis
    let csvContent = "Type,Metric,Value\n";
    
    // Race Overview data
    Object.entries(currentData.race_overview || {}).forEach(([key, value]) => {
        csvContent += `Race Overview,${key},${value}\n`;
    });
    
    // Performance Metrics data
    Object.entries(currentData.performance_metrics || {}).forEach(([key, value]) => {
        csvContent += `Performance Metrics,${key},${value}\n`;
    });
    
    downloadFile(csvContent, `Lapla_Data_Export_${Date.now()}.csv`, 'text/csv');
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function getCurrentInsightsData() {
    // Return the current insights data from the page
    return window.currentInsightsData || null;
}

function displayInsights(data) {
    // Display race overview
    if (data.race_overview) {
        displayRaceOverview(data.race_overview);
    }
    
    // Display driver performance
    if (data.driver_performance) {
        displayDriverPerformance(data.driver_performance);
    }
    
    // Display performance metrics
    if (data.performance_metrics) {
        displayPerformanceMetrics(data.performance_metrics);
    }
    
    // Display strategic insights
    if (data.strategic_insights) {
        displayStrategicInsights(data.strategic_insights);
    }
}

function displayRaceOverview(overview) {
    const section = document.getElementById('raceOverview');
    section.style.display = 'block';
    
    // Update metrics
    const metricsDiv = document.getElementById('overviewMetrics');
    metricsDiv.innerHTML = `
        <div class="col-md-3">
            <div class="metric-item">
                <div class="metric-value">${overview.total_drivers || 'N/A'}</div>
                <div class="metric-label">Total Drivers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-item">
                <div class="metric-value">${overview.total_laps || 'N/A'}</div>
                <div class="metric-label">Total Laps</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-item">
                <div class="metric-value">${overview.fastest_lap_time || 'N/A'}</div>
                <div class="metric-label">Fastest Lap</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-item">
                <div class="metric-value">${overview.track_temperature || 'N/A'}°C</div>
                <div class="metric-label">Track Temp</div>
            </div>
        </div>
    `;
    
    // Update fastest lap
    if (overview.fastest_lap) {
        const fastestLapCard = document.getElementById('fastestLapCard');
        const fastestLapInfo = document.getElementById('fastestLapInfo');
        
        fastestLapInfo.innerHTML = `
            <div class="driver-name">${overview.fastest_lap.driver}</div>
            <div class="lap-time">${overview.fastest_lap.time}</div>
            <small class="text-muted">Lap ${overview.fastest_lap.lap_number}</small>
        `;
        
        fastestLapCard.style.display = 'block';
    }
}

function displayDriverPerformance(performance) {
    const section = document.getElementById('driverPerformance');
    const tbody = document.getElementById('driverPerformanceTable');
    
    section.style.display = 'block';
    
    let html = '';
    performance.drivers.forEach((driver, index) => {
        html += `
            <tr>
                <td>
                    <span class="position-badge position-${index + 1}">${index + 1}</span>
                </td>
                <td>
                    <div class="driver-info">
                        <strong>${driver.driver_name}</strong>
                        <small class="d-block text-muted">${driver.driver_code}</small>
                    </div>
                </td>
                <td>${driver.team_name}</td>
                <td>${driver.best_lap_time || 'N/A'}</td>
                <td>${driver.avg_lap_time || 'N/A'}</td>
                <td>${driver.consistency_rating || 'N/A'}</td>
                <td>
                    <div class="performance-rating">
                        <span>${driver.performance_rating || 'N/A'}</span>
                        <div class="rating-bar">
                            <div class="rating-fill" style="width: ${(driver.performance_rating || 0) * 10}%"></div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function displayPerformanceMetrics(metrics) {
    const section = document.getElementById('performanceMetrics');
    const grid = document.getElementById('metricsGrid');
    
    section.style.display = 'block';
    
    let html = '';
    Object.entries(metrics).forEach(([key, value]) => {
        html += `
            <div class="col-md-3 mb-3">
                <div class="card insight-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar insight-icon"></i>
                        <h5>${key.replace(/_/g, ' ').toUpperCase()}</h5>
                        <p class="mb-0">${value}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

function displayStrategicInsights(insights) {
    const section = document.getElementById('strategicInsights');
    const grid = document.getElementById('insightsGrid');
    
    section.style.display = 'block';
    
    let html = '';
    insights.forEach(insight => {
        html += `
            <div class="col-md-4 mb-3">
                <div class="card insight-card">
                    <div class="card-body">
                        <i class="fas fa-lightbulb insight-icon"></i>
                        <h6>${insight.title}</h6>
                        <p class="mb-2">${insight.description}</p>
                        <div class="confidence-stars">
                            ${'★'.repeat(insight.confidence || 3)}${'☆'.repeat(5 - (insight.confidence || 3))}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

function refreshInsights() {
    generateInsights();
}

function exportPerformanceData(format) {
    const year = document.getElementById('seasonSelect').value;
    const round = document.getElementById('roundSelect').value;
    const session = document.getElementById('sessionSelect').value;
    
    if (!year || !round || !session) {
        alert('Please generate insights first');
        return;
    }
    
    window.open(`/api/export-insights/${year}/${round}/${session}?format=${format}`, '_blank');
}
</script>
{% endblock %}